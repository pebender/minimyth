diff -Naur gnash-0.8.4-old/configure.ac gnash-0.8.4-new/configure.ac
--- gnash-0.8.4-old/configure.ac	2008-10-13 06:01:34.000000000 -0700
+++ gnash-0.8.4-new/configure.ac	2008-10-18 23:17:20.000000000 -0700
@@ -1348,7 +1348,7 @@
   AC_CHECK_LIB(Xi, XInput_find_display)
   AC_CHECK_LIB(X11, XDisableAccessControl)
 dnl fi
-AM_CONDITIONAL(HAVE_X11, [test x$x11 = xyes])
+AM_CONDITIONAL(HAVE_X11, [test "x$HAVE_X11" = "xyes"])
 AC_CHECK_LIB(rt, shm_unlink)
 AC_CHECK_FUNCS(shm_open shm_unlink)
 AC_TRY_COMPILE([#include <strings.h>], [
@@ -1639,12 +1639,19 @@
 AM_CONDITIONAL(HAVE_QT_3, [test x"${gnash_qt_version}" != x && test "${gnash_qt_version}" -eq 3])
 AM_CONDITIONAL(HAVE_QT_4, [test x"${gnash_qt_version}" != x && test "${gnash_qt_version}" -eq 4])
 
+AC_ARG_ENABLE(glib, AC_HELP_STRING([--enable-glib], [Enable support for GLIB]),
+[case "${enableval}" in
+  yes) glib=yes ;;
+  no)  glib=no ;;
+  *)   AC_MSG_ERROR([bad value ${enableval} for enable-glib option]) ;;
+esac], glib=no)
+
 dnl Need GLIB for both GTK and GST
-if test x$build_gtk = xyes -o x${Media_handler} = "xgst"; then
+if test x$build_gtk = xyes -o x${Media_handler} = "xgst" -o "x$glib" = "xyes" ; then
   GNASH_PATH_GLIB
 fi
 
-AM_CONDITIONAL(HAVE_GLIB, [ test x$has_glib = xyes ])
+AM_CONDITIONAL(HAVE_GLIB, [ test "x$HAVE_GLIB" = "xyes" ])
 
 if test x$build_gtk = xno -a x$npapi = xyes; then
   AC_MSG_WARN(["Enabled NPAPI plugin, but you aren't building a GTK based GUI!"])
@@ -1777,7 +1784,7 @@
   GNASH_PATH_FFMPEG
   if test x"${media_handler_specified}" = xfalse; then
      # If the library is not found, or its version is not ok, we'll try gst
-     if test x"${ac_cv_path_ffmpeg_lib}" = x -o x"${ffmpeg_version_check}" != xok; then
+     if test "x$FFMPEG_LIBS" = "x" -o "x$HAVE_FFMPEG" != "xyes"; then
        AC_MSG_WARN([No appropriate ffmpeg library found, disabling media handling.])
        media_handler=none
      fi
@@ -2581,9 +2588,9 @@
   if test x"$media_handler" = x"ffmpeg"; then
     if test x"$FFMPEG_LIBS" != x; then
       echo "        MP3 and video support enabled through ffmpeg"
-      if test x"${ffmpeg_version_check}" != xok; then
-        echo "        ERROR: You have version ${ffmpeg_version} of ffmpeg installed," >&3
-        if test x"${have_ffmpeg_swscale}" = "xno"; then
+      if test "x$HAVE_AVCODEC" != "xyes" ; then
+        echo "        ERROR: You have version $FFMPEG_VERSION of ffmpeg installed," >&3
+        if test "x$HAVE_SWCALE" != "xyes"; then
           echo "               with no swscale enabled." >&3
         else
           echo "               with swscale enabled." >&3
@@ -2591,12 +2598,11 @@
         echo "               This setup isn't supported!" >&3
         echo "               Version 51.11.0 or newer is required, enabling swscale if >= 52.0.0." >&3
       else
-	if test x"${avformat_h}" = x; then
-          echo "        ERROR: FFMPEG's libavcodec header is installed but not libavformat." >&3
+	if test "x$HAVE_AVFORMAT" != "xyes" ; then
+          echo "        ERROR: FFMPEG's libavcodec is installed but not libavformat." >&3
           echo "               You can install FFMPEG from http://ffmpeg.mplayerhq.hu" >&3
           echo "               or .deb users: apt-get install libavformat-dev" >&3
           echo "               or YaST users: yast -i libavformat-api (but currently installs into /usr/lib64)" >&3
-          echo "               or explicitly set the path using --with-ffmpeg-incl=" >&5
           echo "               or reconfigure with --enable-media=gst" >&3
 	else
           if test x"$FFMPEG_CFLAGS" != x; then
@@ -2707,8 +2713,6 @@
   fi
   if test x"$PTHREAD_LIBS" != x; then
     echo "        POSIX Threads lib is: $PTHREAD_LIBS"
-  else
-    echo "ERROR: No pthread development package installed!" >&3
   fi
 fi
 
@@ -2772,21 +2776,13 @@
 
 if test x$build_agg = xyes; then # {
   echo "        AGG Pixel format is: $pixelformat"
-    if test x"$AGG_LIBS" != x; then # {
-      if test x"${agg25}" != xyes; then # {
-        echo "        ERROR: Your installation of AGG appears to be version 2.4 or older." >&3
-        echo "               Please upgrade to AGG 2.5 or greater." >&3
-        echo "               Install it from http://www.antigrain.com" >&3
-        echo "               or .deb users: apt-get install libagg-dev" >&3
-        echo "               or .rpm users: yum install agg-devel" >&3
+    if test "x$HAVE_AGG" = "xyes" ; then # {
+      if test "x$AGG_CFLAGS" != "x" ; then # {
+        echo "        AGG flags are: $AGG_CFLAGS"
       else # }{
-        if test x"$AGG_CFLAGS" != x; then # {
-          echo "        AGG flags are: $AGG_CFLAGS"
-        else # }{
-          echo "        AGG flags are: default include path"
-        fi # }
-        echo "        AGG libs are: $AGG_LIBS"
+        echo "        AGG flags are: default include path"
       fi # }
+      echo "        AGG libs are: $AGG_LIBS"
     else # }{
       echo "        ERROR: No AGG development package installed!" >&3
       echo "               Install it from http://www.antigrain.com" >&3
diff -Naur gnash-0.8.4-old/macros/agg.m4 gnash-0.8.4-new/macros/agg.m4
--- gnash-0.8.4-old/macros/agg.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/agg.m4	2008-10-18 22:52:46.000000000 -0700
@@ -19,123 +19,9 @@
 dnl but not in AGG 2.3. As we need AGG 2.4, we use this as 
 AC_DEFUN([GNASH_PATH_AGG],
 [
-  dnl Lool for the header
-  AC_ARG_WITH(agg_incl, AC_HELP_STRING([--with-agg-incl], [directory where AGG headers are]), with_agg_incl=${withval})
-  AC_MSG_CHECKING([for AGG headers])
-  AC_CACHE_VAL(ac_cv_path_agg_incl, [
-    if test x"${with_agg_incl}" != x ; then
-      if test -f ${with_agg_incl}/agg_rasterizer_compound_aa.h ; then
-        agg_include_dir="`(cd ${with_agg_incl}; pwd)`"
-        ac_cv_path_agg_incl="-I${agg_include_dir}"
-        agg25=yes
-      else
-        AC_MSG_ERROR([${with_agg_incl} directory doesn't contain any headers])
-        agg25=no
-      fi
-    fi
-  ])
-
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_agg_incl}" = x; then
-      if $PKG_CONFIG --exists libagg ; then
-        ac_cv_path_agg_incl="`$PKG_CONFIG --cflags libagg`"
-        $PKG_CONFIG --atleast-version 2.5.0 libagg && agg25=yes
- 
-        dnl I think this setting of agg_include_dir is too error prone!
-        agg_include_dir="`$PKG_CONFIG --cflags-only-I libagg | cut -d " " -f 1 | sed -e 's/-I//g'`"
-        if test -f $agg_include_dir/agg_gradient_lut.h ; then
-          agg25=yes
-        fi
-      fi
-    fi
-  fi
-
-  if test x"${ac_cv_path_agg_incl}" = x; then
-    for i in $incllist; do
-      if test -f $i/agg2/agg_gradient_lut.h; then
-        ac_cv_path_agg_incl="-I$i/agg2"
-        agg_include_dir=$i/agg2
-	      agg25=yes
-        break
-      fi
-    done
-  fi
-
-  AC_MSG_RESULT(${ac_cv_path_agg_incl})
-
-  if test x"${ac_cv_path_agg_incl}" != x ; then
-    AGG_CFLAGS="${ac_cv_path_agg_incl}"
-  fi
+  PKG_CHECK_MODULES(AGG, [libagg >= 2.5.0], [HAVE_AGG=yes], [HAVE_AGG=no])
 
   AC_SUBST(AGG_CFLAGS)
-
-
-  dnl Look for the library
-  AC_ARG_WITH(agg_lib, AC_HELP_STRING([--with-agg-lib], [directory where AGG libraries are]), with_agg_lib=${withval})
-  AC_CACHE_VAL(ac_cv_path_agg_lib,[
-    if test x"${with_agg_lib}" != x ; then
-      if test -f ${with_agg_lib}/libagg.a -o -f ${with_agg_lib}/libagg.${shlibext}; then
-      	ac_cv_path_agg_lib="-L`(cd ${with_agg_lib}; pwd)`"
-      else
-      	AC_MSG_ERROR([${with_agg_lib} directory doesn't contain AGG libraries.])
-      fi
-    fi
-  ])
-
-  pkg=no
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_agg_lib}" = x; then
-      $PKG_CONFIG --exists libagg && ac_cv_path_agg_lib="`$PKG_CONFIG --libs-only-l libagg`"
-      $PKG_CONFIG --exists libagg && ac_cv_path_agg_lib="${ac_cv_path_agg_lib}`$PKG_CONFIG --libs-only-l libagg`"
-      $PKG_CONFIG --exists libagg && pkg=yes
-    fi
-  fi
-
-  AC_LANG_PUSH(C++)
-  if test x"${ac_cv_path_agg_lib}" = x; then
-    for i in $libslist; do
-      if test -f $i/libagg.a -o -f $i/libagg.${shlibext}; then
-      	if test ! x"$i" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64"; then
-      	  ac_cv_path_agg_lib="-L$i"
-      	  break
-        else
-      	  ac_cv_path_agg_lib=""
-      	  break
-        fi
-      fi
-    done
-  fi
-  
-  if test x"${ac_cv_path_agg_lib}" = x; then
-    AC_CHECK_LIB(agg, agg::gamma_ctrl_impl::calc_points, [ac_cv_path_agg_lib=""])
-  fi
-  AC_MSG_CHECKING([for libagg library])
-  AC_MSG_RESULT(${ac_cv_path_agg_lib})
-  AC_LANG_POP(C++)
-
-  if test x"${ac_cv_path_agg_lib}" != x -a x"$pkg" = x"yes"; then
-    AGG_LIBS="${ac_cv_path_agg_lib}"
-  else
-    if test x"$agg25" = x"yes"; then
-      AGG_LIBS="${ac_cv_path_agg_lib} -lagg"
-    else
-      AGG_LIBS=""
-    fi     
-  fi
-
-dnl   AC_EGREP_HEADER(render_scanlines_compound_layered, 
-dnl 	${agg_include_dir}/agg_renderer_scanline.h,
-dnl 	[ agg_need_compatibility_layer="no" ],
-dnl 	[ agg_need_compatibility_layer="yes" ] )
-
-dnl   AC_SUBST(agg_need_compatibility_layer)
-
-dnl   if test x"${agg_need_compatibility_layer}" = xyes; then
-dnl 	AC_DEFINE(HAVE_AGG_SCANLINES_COMPOUND_LAYERED, [0], [AGG headers include the render_scanlines_compound_layered templated function])
-dnl   else
-dnl 	AC_DEFINE(HAVE_AGG_SCANLINES_COMPOUND_LAYERED, [1], [AGG headers include the render_scanlines_compound_layered templated function])
-dnl   fi
-
   AC_SUBST(AGG_LIBS)
 ])
 
diff -Naur gnash-0.8.4-old/macros/boost.m4 gnash-0.8.4-new/macros/boost.m4
--- gnash-0.8.4-old/macros/boost.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/boost.m4	2008-10-18 22:52:46.000000000 -0700
@@ -63,7 +63,7 @@
     dnl Attempt to find the top level directory, which unfortunately has a
     dnl version number attached. At least on Debian based systems, this
     dnl doesn't seem to get a directory that is unversioned.
-    if test x$cross_compiling = xno; then
+    if test xno = xno; then
       if test x"$PKG_CONFIG" != x; then
         AC_MSG_CHECKING([for the Boost Version])
         $PKG_CONFIG --exists boost && gnash_boost_version="`$PKG_CONFIG --modversion boost | cut -d "." -f 1 | awk '{print $'0'".0"}'`"
diff -Naur gnash-0.8.4-old/macros/curl.m4 gnash-0.8.4-new/macros/curl.m4
--- gnash-0.8.4-old/macros/curl.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/curl.m4	2008-10-18 22:52:46.000000000 -0700
@@ -17,109 +17,11 @@
 
 AC_DEFUN([GNASH_PATH_CURL],
 [
-  dnl Look for the header
-  AC_ARG_WITH(curl_incl, AC_HELP_STRING([--with-curl-incl], [directory where libcurl header is (w/out the curl/ prefix)]), with_curl_incl=${withval})
-    AC_CACHE_VAL(ac_cv_path_curl_incl,[
-    if test x"${with_curl_incl}" != x ; then
-      if test -f ${with_curl_incl}/curl/curl.h ; then
-	      ac_cv_path_curl_incl="`(cd ${with_curl_incl}; pwd)`"
-      else
-	      AC_MSG_ERROR([${with_curl_incl} directory doesn't contain curl/curl.h])
-      fi
-    fi
-  ])
+  PKG_CHECK_MODULES(CURL, [libcurl], [HAVE_CURL=yes], [HAVE_CURL=no])
 
-  curlconfig=""
-  AC_PATH_PROG(curlconfig, curl-config, ,[${pathlist}])
+  AM_CONDITIONAL(CURL, [test "x$HAVE_CURL" = "xyes"])
 
-  dnl If the path hasn't been specified, go look for it.
-  if test x"${ac_cv_path_curl_incl}" = x; then
-    if test x"${curlconfig}" != "x"; then
-      ac_cv_path_curl_incl="`${curlconfig} --cflags`"
-    else
-      for i in $incllist; do
-        if test -f $i/curl/curl.h; then
-          ac_cv_path_curl_incl="-I$i"
-	        break
-        fi
-      done
-    fi
-
-    if test x"${ac_cv_path_curl_incl}" = x ; then
-      AC_CHECK_HEADERS(curl/curl.h)
-    fi
-
-    AC_MSG_CHECKING([for libcurl header])
-    if test x"${ac_cv_path_curl_incl}" != x ; then
-      AC_MSG_RESULT(yes)
-    else
-      AC_MSG_RESULT(no)
-    fi
-  fi
-
-
-  if test x"${ac_cv_path_curl_incl}" != x"/usr/include"; then
-    ac_cv_path_curl_incl="${ac_cv_path_curl_incl}"
-  else
-    ac_cv_path_curl_incl=""
-  fi
-
-  dnl Look for the library
-  AC_ARG_WITH(curl_lib, AC_HELP_STRING([--with-curl-lib], [directory where curl library is]), with_curl_lib=${withval})
-    AC_CACHE_VAL(ac_cv_path_curl_lib,[
-    if test x"${with_curl_lib}" != x ; then # {
-      if test -f ${with_curl_lib}/libcurl.a -o -f ${with_curl_lib}/libcurl.${shlibext}; then # {
-        ac_cv_path_curl_lib="-L`(cd ${with_curl_lib}; pwd)`"
-      else # }{
-        AC_MSG_ERROR([${with_curl_lib} directory doesn't contain libcurl.])
-      fi # }
-    fi # }
-  ])
-
-  dnl If the path hasn't been specified, go look for it.
-  if test x"${ac_cv_path_curl_lib}" = x; then # {
-    if test x"${curlconfig}" != "x" -a x"${darwin}" = xno; then # {
-      dnl curl-config gives us way to many libraries, which create nasty linking
-      dnl dependancy issue, so we strip them off here. The real dependencies are
-      dnl are taken care of by other config tests.
-      ac_cv_path_curl_lib=`${curlconfig} --libs | sed -e 's/lcurl.*/lcurl/' -e 's:-L/usr/lib ::'`
-    else # }{
-      AC_MSG_CHECKING([for libcurl library])
-      for i in $libslist; do # {
-        if test -f $i/libcurl.a -o -f $i/libcurl.${shlibext}; then # {
-          if test ! x"$i" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64"; then # {
-            ac_cv_path_curl_lib="-L$i -lcurl"
-            AC_MSG_RESULT(${ac_cv_path_curl_lib})
-            break
-          else # }{
-            ac_cv_path_curl_lib="-lcurl"
-            AC_MSG_RESULT(yes)
-            break
-          fi # }
-        fi # }
-      done # }
-      if test x"${ac_cv_path_curl_lib}" = x; then # {
-        AC_MSG_RESULT(no)
-      fi # }
-    fi # }
-
-  fi # }
-
-  if test x"${ac_cv_path_curl_incl}" != x ; then
-    CURL_CFLAGS="${ac_cv_path_curl_incl}"
-  else
-    CURL_CFLAGS=""
-  fi
-
-  if test x"${ac_cv_path_curl_lib}" != x ; then
-    CURL_LIBS="${ac_cv_path_curl_lib}"
-  else
-    CURL_LIBS=""
-  fi
-
-  AM_CONDITIONAL(CURL, [test -n "$CURL_LIBS"])
-
-  if test -n "$CURL_LIBS"; then
+  if test "x$HAVE_CURL" = "xyes"; then
     AC_DEFINE(USE_CURL, [1], [Define this if you want to enable curl usage])
   fi
 
diff -Naur gnash-0.8.4-old/macros/dbus.m4 gnash-0.8.4-new/macros/dbus.m4
--- gnash-0.8.4-old/macros/dbus.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/dbus.m4	2008-10-18 22:52:46.000000000 -0700
@@ -17,115 +17,7 @@
 
 AC_DEFUN([GNASH_PATH_DBUS],
 [
-
-  dnl Look for the header
-  AC_ARG_WITH(dbus_incl, AC_HELP_STRING([--with-dbus-incl], [directory where libdbus header is]), with_dbus_incl=${withval})
-  AC_CACHE_VAL(ac_cv_path_dbus_incl,[
-    if test x"${with_dbus_incl}" != x ; then
-      if test -f ${with_dbus_incl}/dbus/dbus.h ; then
-        ac_cv_path_dbus_incl="-I`(cd ${with_dbus_incl}; pwd)`"
-      else
-        AC_MSG_ERROR([${with_dbus_incl} directory doesn't contain dbus/dbus.h])
-      fi
-    fi
-  ])
-
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_dbus_incl}" = x; then
-      $PKG_CONFIG --exists dbus-1 && ac_cv_path_dbus_incl=`$PKG_CONFIG --cflags dbus-1`
-    fi
-  fi
-
-  dnl Attempt to find the top level directory, which unfortunately has a
-  dnl version number attached. At least on Debain based systems, this
-  dnl doesn't seem to get a directory that is unversioned.
-
-  AC_MSG_CHECKING([for the Dbus Version])
-
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x; then
-      $PKG_CONFIG --exists dbus-1 && gnash_dbus_version=`$PKG_CONFIG --modversion dbus-1 | cut -d "." -f 1 | awk '{print $'0'".0"}'`
-    fi
-  fi
-
-  if test x"${gnash_dbus_version}" = x; then
-    gnash_dbus_topdir=""
-    gnash_dbus_version=""
-    for i in $incllist; do
-      for j in `ls -dr $i/dbus-[[0-9]].[[0-9]] 2>/dev/null`; do
-        if test -f $j/dbus.h; then
-	      gnash_dbus_topdir=`basename $j`
-	      gnash_dbus_version=`echo ${gnash_dbus_topdir} | sed -e 's:dbus-::' -e 's:.0::'`
- 	      ac_cv_path_dbus_incl="-I$i/${gnash_dbus_topdir}"
-	      break
-	    fi
-      done
-	  if test x$gnash_dbus_version != x; then
-	    break;
-	  fi
-    done
-  fi      
-
-  if test x"${gnash_dbus_version}" = x; then
-    AC_MSG_RESULT(none)
-  else
-    AC_MSG_RESULT([${gnash_dbus_version}])
-  fi
-  
-  AC_MSG_CHECKING([for Dbus headers])
-  AC_MSG_RESULT(${ac_cv_path_dbus_incl}) 
-
-  dnl Look for the library
-  AC_ARG_WITH(dbus_lib, AC_HELP_STRING([--with-dbus-lib], [directory where dbus library is]), with_dbus_lib=${withval})
-  AC_CACHE_VAL(ac_cv_path_dbus_lib,[
-    if test x"${with_dbus_lib}" != x ; then
-      if test -f ${with_dbus_lib}/libdbus-1.a -o -f ${with_dbus_lib}/libdbus-1.${shlibext}; then
-	      ac_cv_path_dbus_lib="-L`(cd ${with_dbus_lib}; pwd)`"
-      else
-	      AC_MSG_ERROR([${with_dbus_lib} directory doesn't contain libdbus.])
-      fi
-    fi
-  ])
-  
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_dbus_lib}" = x; then
-      $PKG_CONFIG --exists dbus-1 && ac_cv_path_dbus_lib=`$PKG_CONFIG --libs-only-l dbus-1`
-    fi
-  fi
-
-  if test x"${ac_cv_path_dbus_lib}" = x; then
-    newlist="/lib /lib64 $libslist"
-    for i in $newlist; do
-      if test -f $i/libdbus-${gnash_dbus_version}.a -o -f $i/libdbus-${gnash_dbus_version}.${shlibext}; then
-        if test x"$i" != x"/lib"; then
-	        ac_cv_path_dbus_lib="-L$i -ldbus-${gnash_dbus_version}"
-	        break
-        else
-	        ac_cv_path_dbus_lib="-ldbus-${gnash_dbus_version}"
-	  break
-	fi
-      fi
-    done
-  fi
-	
-  AC_MSG_CHECKING([for Dbus library])
-  AC_MSG_RESULT(${ac_cv_path_dbus_lib})
-  
-  if test x"${ac_cv_path_dbus_lib}" = x; then
-    AC_CHECK_LIB(dbus-${gnash_dbus_version}, dbus_engine_shape_class_init, [ac_cv_path_dbus_lib="-ldbus-${gnash_dbus_version}"])
-  fi
-
-  if test x"${ac_cv_path_dbus_incl}" != x; then
-    DBUS_CFLAGS="${ac_cv_path_dbus_incl}"
-  else
-    DBUS_CFLAGS=""
-  fi
-
-  if test x"${ac_cv_path_dbus_lib}" != x; then
-    DBUS_LIBS="${ac_cv_path_dbus_lib}"
-  else
-    DBUS_LIBS=""
-  fi
+  PKG_CHECK_MODULES(DBUS, dbus-1, [HAVE_DBUS=yes], [HAVE_DBUS=no])
 
   AC_SUBST(DBUS_CFLAGS)
   AC_SUBST(DBUS_LIBS)
diff -Naur gnash-0.8.4-old/macros/ffmpeg.m4 gnash-0.8.4-new/macros/ffmpeg.m4
--- gnash-0.8.4-old/macros/ffmpeg.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/ffmpeg.m4	2008-10-18 22:52:46.000000000 -0700
@@ -17,547 +17,55 @@
 
 AC_DEFUN([GNASH_PATH_FFMPEG],
 [
+  FFMPEG_CFLAGS=
+  FFMPEG_LIBS=
 
-  dnl Backup LIBS and CFLAGS vars, we'll add user-specified dirs there
-  backupLIBS="$LIBS"
-  backupCFLAGS="$CFLAGS"
-
-  dnl Did they tell us where the header is?
-  AC_ARG_WITH(ffmpeg_incl, AC_HELP_STRING([--with-ffmpeg-incl], [directory where ffmpeg headers are]), with_ffmpeg_incl=${withval})
-  AC_CACHE_VAL(ac_cv_path_ffmpeg_incl,[
-    if test x"${with_ffmpeg_incl}" != x ; then
-      avcodec_h=""
-      if test -f ${with_ffmpeg_incl}/ffmpeg/avcodec.h ; then
-        ac_cv_path_ffmpeg_incl="-I`(cd ${with_ffmpeg_incl}; pwd)`"
-        avcodec_h="${with_ffmpeg_incl}/ffmpeg/avcodec.h"
-      fi
-      if test -f ${with_ffmpeg_incl}/libavcodec/avcodec.h ; then
-        ac_cv_path_ffmpeg_incl="-I`(cd ${with_ffmpeg_incl}; pwd)`"
-        if test x$avcodec_h != x; then
-          AC_MSG_ERROR([${with_ffmpeg_incl} directory contains both the ffmpeg/avcodec.h and libavcodec/avcodec.h headers])
-        fi
-        avcodec_h="${with_ffmpeg_incl}/libavcodec/avcodec.h"
-      fi
-      if test x$avcodec_h != x; then
-        CFLAGS="$ac_cv_path_ffmpeg_incl $CFLAGS"
-      else
-        AC_MSG_ERROR([${with_ffmpeg_incl} directory contains neither the ffmpeg/avcodec.h nor libavcodec/avcodec.h header])
-      fi
-      topdir=${with_ffmpeg_incl}
-    fi
-  ])
-
-  if test x${cross_compiling} = xno; then
-    AC_MSG_CHECKING([location of avcodec.h])
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_ffmpeg_incl}" = x; then
-      if $PKG_CONFIG --exists libavcodec; then
-	# Some systems return /usr/include/ffmpeg, others /usr/include.
-	# We use #include <ffmpeg/avcodec.h> everywhere so weed out funny
-	# values into the short form.
-
-	# Here pkg-config outputs two spaces on the end, so match those too!
-	ac_cv_path_ffmpeg_incl=`$PKG_CONFIG --cflags libavcodec | sed 's:/ffmpeg *$::'`
-        CFLAGS="$ac_cv_path_ffmpeg_incl $CFLAGS"
-        # ac_cv_path_ffmpeg_incl might include several paths (e.g. pointers to
-        # external libraries used by ffmpeg). Let's find the right one.
-        for i in `$PKG_CONFIG --cflags-only-I libavcodec |sed -e 's:-I::g'`; do
-          if test -e "$i"/avcodec.h -o \
-                  -e "$i"/ffmpeg/avcodec.h -o \
-                  -e "$i"/libavcodec/avcodec.h; then
-            topdir="$i"
-            break
-          fi
-        done
-      else
-        # Let's see if ffmpeg is installed without using pkgconfig...
-        for i in /usr/include /usr/local/include /opt/ffmpeg/include; do
-          if test -e "$i"/ffmpeg/avcodec.h -o \
-                  -e "$i"/libavcodec/avcodec.h; then
-            topdir="$i"
-            break
-          fi
-        done
-      fi
-      # Again adjust for ffmpeg/ foolery
-      topdir=`echo "$topdir" | sed 's:/ffmpeg *$::'`
-      # Gets "" if not installed
-      if test x"$topdir" != x; then
-        if test -e "$topdir/ffmpeg/avcodec.h"; then
-          avcodec_h="$topdir/ffmpeg/avcodec.h"
-        else
-          avcodec_h="$topdir/libavcodec/avcodec.h"
-        fi
-      fi
-    fi
-    AC_MSG_RESULT($avcodec_h)
-  fi
-
-  dnl incllist is inherited from configure.ac.
-  if test x"${ac_cv_path_ffmpeg_incl}" = x ; then
-    AC_MSG_CHECKING([location of avcodec.h using incllist])
-    for i in $incllist; do
-      if test -f $i/ffmpeg/avcodec.h; then
-        ac_cv_path_ffmpeg_incl="-I$i"
-        CFLAGS="$ac_cv_path_ffmpeg_incl $CFLAGS"
-        topdir=$i
-        avcodec_h="$i/ffmpeg/avcodec.h"
-        break
-      fi
-      if test -f $i/libavcodec/avcodec.h; then
-        ac_cv_path_ffmpeg_incl="-I$i"
-        CFLAGS="$ac_cv_path_ffmpeg_incl $CFLAGS"
-        topdir=$i
-        avcodec_h="$i/libavcodec/avcodec.h"
-        break
-      fi
-    done
-    AC_MSG_RESULT($avcodec_h)
-  fi
-
-  if test x"${ac_cv_path_ffmpeg_incl}" = x; then
-     AC_MSG_ERROR([Cannot find ffmpeg/avcodec.h.  Use --with-ffmpeg-incl= to specify the location of the *directory* holding avcodec.h])
-  else
-    if echo $avcodec_h | grep -q ffmpeg/avcodec.h; then
-      AC_DEFINE(HAVE_FFMPEG_AVCODEC_H, 1, [Define if you have avcodec.h installed.])
-    else
-      AC_DEFINE(HAVE_LIBAVCODEC_AVCODEC_H, 1, [Define if you have avcodec.h installed.])
-    fi
-  fi
-
-dnl Find and check libavcodec version number to make sure we have a usable
-dnl version and to enable/disable features according to version.
-dnl We need LIBAVCODEC VERSION of at least 51.29.0 to get avcodec_decode_audio2
-
-dnl We try to get the avcodec version as a decimal number
-dnl so that we can compare it numerically against what we require.
-dnl
-dnl This previous version makes ffmpeg fail and then grubs the version string
-dnl out of the resulting usage message e.g. "  libavcodec version: 51.40.2"
-dnl Early versions of ffmpeg do not output this string at all.
-dnl
-dnl   AC_PATH_PROG(FFMPEG, ffmpeg, ,[${pathlist}])
-dnl   if test "x$FFMPEG" = "x" ; then
-dnl     ffmpeg_version=`$FFMPEG uglyhack 2>&1 | grep "libavcodec version" | cut -d ' ' -f 5 | tr -d '.'`
-dnl     if test "$ffmpeg_version" -lt 51290; then
-dnl       AC_MSG_ERROR([])
-dnl     fi
-dnl   fi
-dnl
-dnl These days we check avcodec.h and pick the version out of the constants,
-dnl simply throwing away all non-digits.
-dnl
-dnl In earlier versions we have:
-dnl #define FFMPEG_VERSION_INT     0x000409
-dnl #define FFMPEG_VERSION         "0.4.9-pre1"
-dnl #define LIBAVCODEC_BUILD       4731
-dnl #define LIBAVCODEC_VERSION_INT FFMPEG_VERSION_INT
-dnl #define LIBAVCODEC_VERSION     FFMPEG_VERSION
-dnl
-dnl elsewhere, FFMPEG_VERSION may also be the quoted string "CVS"
-dnl
-dnl This changed from the above to
-dnl #define LIBAVCODEC_VERSION_INT ((49<<16)+(0<<8)+0)
-dnl #define LIBAVCODEC_VERSION     49.0.0
-dnl #define LIBAVCODEC_BUILD       LIBAVCODEC_VERSION_INT
-dnl (note, LIBAVCODEC_VERSION also changes from a quoted string to unquoted)
-dnl see http://lists.mplayerhq.hu/pipermail/ffmpeg-cvslog/2005-July/000570.html
-dnl
-dnl
-dnl This changed from the above to
-dnl #define LIBAVCODEC_VERSION_MAJOR 51
-dnl #define LIBAVCODEC_VERSION_MINOR 54
-dnl #define LIBAVCODEC_VERSION_MICRO  0
-dnl 
-dnl #define LIBAVCODEC_VERSION_INT  AV_VERSION_INT(LIBAVCODEC_VERSION_MAJOR, \
-dnl                                                LIBAVCODEC_VERSION_MINOR, \
-dnl                                                LIBAVCODEC_VERSION_MICRO)
-dnl #define LIBAVCODEC_VERSION      AV_VERSION(LIBAVCODEC_VERSION_MAJOR,    \
-dnl                                            LIBAVCODEC_VERSION_MINOR,    \
-dnl                                            LIBAVCODEC_VERSION_MICRO)
-
-dnl Those deb-heads at Debian redefine LIBAVCODEC_VERSION in their versions to
-dnl (e.g.) 1d.51.38.0 or dnl 0d.51.11.0 - we need to discard the prefixed
-dnl rubbish.
-dnl
-dnl Other values or LIBAVCODEC_VERSION spotted in the wild:
-dnl 50.0.0  50.5.0  51.7.0  51.8.0  0d.51.8.0  51.40.4
-dnl presumably this will change to 52.0.0 at some point...
-dnl
-dnl We can ignore the very early versions because 51.10.0 is necessary to decode
-dnl Flash video at all. However the current solution will incorrectly succeed
-dnl on early debian/ubuntu 1d.* version numbers and incorrectly fail
-dnl when 52.0.0 happens.
-dnl
-dnl The most reliable way is to compile a test program to print the value of
-dnl LIBAVCODEC_BUILD, which got up to dnl 4718 at version 0.4.9-pre1,
-dnl then changed to (major<<16 + minor<<8 + micro) from then on.
-dnl There is code to do this in transcode's configure.in, but when
-dnl cross-compiling we cannot run a test program, which suggests that
-dnl a modified form of grepping may be better, making sure all old kinds of
-dnl version numbering fail gracefully.
-
-# Check avcodec version number, if it was found
-  if test x"${avcodec_h}" != x; then
-
-    AC_MSG_CHECKING([ffmpeg version])
-
-    ffmpeg_major_version=`$EGREP "define LIBAVCODEC_VERSION_MAJOR " ${avcodec_h} | sed -e "s%[[^0-9]]%%g"`
-    ffmpeg_minor_version=`$EGREP "define LIBAVCODEC_VERSION_MINOR " ${avcodec_h} | sed -e "s%[[^0-9]]%%g"`
-    ffmpeg_micro_version=`$EGREP "define LIBAVCODEC_VERSION_MICRO " ${avcodec_h} | sed -e "s%[[^0-9]]%%g"`
-
-    if test x"${ffmpeg_major_version}" != x ; then
-
-      ffmpeg_version="${ffmpeg_major_version}.${ffmpeg_minor_version}.${ffmpeg_micro_version}"
-
-    else
-
-      dnl #define LIBAVCODEC_VERSION_TRIPLET 51,50,1
-      ffmpeg_version=`$EGREP "define LIBAVCODEC_VERSION_TRIPLET " ${avcodec_h} | awk '{print $'3'}' | sed -e "s%,%.%g"`
-
-      if test x"${ffmpeg_version}" = x ; then
-
-        dnl NOTE: the [0-9]*d. pattern discards deb-heads rubbish prefix
-        ffmpeg_version=`$EGREP "define LIBAVCODEC_VERSION " ${avcodec_h} | awk '{print $'3'}' | sed -e "s%^[[0-9]]d\.%%"` 
-
-        if test x"${ffmpeg_version}" = x ; then
-          ffmpeg_version=`$EGREP "define LIBAVCODEC_BUILD " ${avcodec_h} | awk '{print $'3'}'`
-        fi
-      fi
-
-      if test x"${ffmpeg_version}" != x ; then
-        ffmpeg_major_version=`echo ${ffmpeg_version} | cut -d. -f1`
-        ffmpeg_minor_version=`echo ${ffmpeg_version} | cut -d. -f2`
-        ffmpeg_micro_version=`echo ${ffmpeg_version} | cut -d. -f3`
-      fi
-
-    fi
-
-    ffmpeg_num_version=`printf %2.2d%2.2d%2.2d $ffmpeg_major_version $ffmpeg_minor_version $ffmpeg_micro_version`
-
-    AC_MSG_RESULT($ffmpeg_version ($ffmpeg_num_version))
-
-
-dnl   AC_EGREP_HEADER(avcodec_decode_audio2, ${avcodec_h}, [avfound=yes], [avfound=no])
-  
-    if test -z "$ffmpeg_num_version" -o "$ffmpeg_num_version" -lt 511100; then
-      AC_MSG_WARN([Wrong ffmpeg/libavcodec version! 51.11.0 or greater required, $ffmpeg_version detected.])
-    else
-      ffmpeg_version_check=ok
-    fi
-
-    if test ! -z "$ffmpeg_num_version" -a "$ffmpeg_num_version" -gt 512800; then
-      dnl 51.28.0 or higher required
-      AC_DEFINE(FFMPEG_AUDIO2, 1, [Define if avcodec_decode_audio2 can be used.])
-    fi
-
-    if test -z "$ffmpeg_num_version" -o "$ffmpeg_num_version" -lt 512700; then
-      dnl 51.27.0 or higher required
-      AC_MSG_WARN([This version of ffmpeg/libavcodec ($ffmpeg_version) is not able to play VP6 encoded video: 51.27.0 or higher required!])
-    else
-      AC_DEFINE(FFMPEG_VP6, 1, [Define if ffmpeg can play VP6.])
-    fi
-
-    if test -z "$ffmpeg_num_version" -o "$ffmpeg_num_version" -lt 514900; then
-      dnl 51.49.0 or higher required
-      AC_MSG_WARN([This version of ffmpeg/libavcodec ($ffmpeg_version) is not able to play VP6A encoded video: 51.49.0 or higher required!])
-    else
-      AC_DEFINE(FFMPEG_VP6A, 1, [Define if ffmpeg can play VP6A.])
-    fi
-
-  else
-    AC_MSG_WARN([Could not check ffmpeg version (dunno where avcodec.h is)])
-    ffmpeg_version_check=ok # trust the user-specified dir
-  fi
+  PKG_CHECK_MODULES(AVCODEC, [libavcodec >= 51.71.0], [HAVE_AVCODEC=yes], [HAVE_AVCODEC=no])
 
-  # Eliminate the pointless -I/usr/include, which can happen
-  if test x"${ac_cv_path_ffmpeg_incl}" != x \
-       -a x"${ac_cv_path_ffmpeg_incl}" != x-I/usr/include ; then
-    FFMPEG_CFLAGS="${ac_cv_path_ffmpeg_incl}"
-  else
-    FFMPEG_CFLAGS=""
-  fi
-
-  AC_MSG_CHECKING([for avformat.h])
-  if test -f "${topdir}/ffmpeg/avformat.h"; then
-    AC_DEFINE(HAVE_FFMPEG_AVFORMAT_H, 1, [Define if avformat.h is found])
-    avformat_h="${topdir}/ffmpeg/avformat.h"
-  else
-    if test -f "${topdir}/libavformat/avformat.h"; then
-      AC_DEFINE(HAVE_LIBAVFORMAT_AVFORMAT_H, 1, [Define if avformat.h is found])
-      avformat_h="${topdir}/libavformat/avformat.h"
-    else
-      avformat_h=""
-    fi
-  fi
-  AC_MSG_RESULT($avformat_h)
+  if test "x$HAVE_AVCODEC" = "xyes" ; then
+    CFLAGS="$AVCODEC_CFLAGS $CFLAGS"
 
-  have_ffmpeg_swscale=no
+    FFMPEG_CFLAGS="$FFMPEG_CFLAGS $AVCODEC_CFLAGS"
+    FFMPEG_LIBS="$FFMPEG_LIBS $AVFORMAT"
 
-  dnl look for swscale.h, but ignore versions older than 51.40.3
-  if test $ffmpeg_num_version -gt 514003; then
-    if test -f "${topdir}/ffmpeg/swscale.h"; then
-      have_ffmpeg_swscale=yes
-      AC_DEFINE(HAVE_FFMPEG_SWSCALE_H, 1, [Define if swscale.h is found])
-    fi
-    if test -f "${topdir}/libswscale/swscale.h"; then
-      have_ffmpeg_swscale=yes
-      AC_DEFINE(HAVE_LIBSWSCALE_SWSCALE_H, 1, [Define if swscale.h is found])
-    fi
-  fi
+    FFMPEG_VERSION=`$PKG_CONFIG --modversion libavcodec`
 
-  if test x"$have_ffmpeg_swscale" = "xno" -a $ffmpeg_num_version -ge 520000; then
-     AC_MSG_WARN([Cannot find swscale.h, required for ffmpeg versions >= 52.0.0 (detected version: $ffmpeg_version)])
-     ffmpeg_version_check=
-  fi
+    AC_DEFINE(HAVE_LIBAVCODEC_AVCODEC_H, 1, [Define if you have avcodec.h installed.])
 
-  dnl Look for the library
-  AC_ARG_WITH(ffmpeg_lib, AC_HELP_STRING([--with-ffmpeg-lib], [directory where ffmpeg libraries are]), with_ffmpeg_lib=${withval})
-  AC_CACHE_VAL(ac_cv_path_ffmpeg_lib, [
-    if test x"${with_ffmpeg_lib}" != x ; then
-      if test -f ${with_ffmpeg_lib}/libavcodec.a -o -f ${with_ffmpeg_lib}/libavcodec.${shlibext}; then
-	      ac_cv_path_ffmpeg_lib="-L`(cd ${with_ffmpeg_lib}; pwd)`"
-              LIBS="${ac_cv_path_ffmpeg_lib} $LIBS"
-      else
-	      AC_MSG_ERROR([${with_ffmpeg_lib} directory doesn't contain ffmpeg libraries.])
-      fi
-    fi
-  ])
-
-  dnl Try with pkg-config
-  if test x"${cross_compiling}" = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_ffmpeg_lib}" = x; then
-      $PKG_CONFIG --exists libavcodec && libavcodec=`$PKG_CONFIG --libs-only-l libavcodec`
-    fi
-  fi
-
-  if test x"${libavcodec}" != x; then
-    ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libavcodec}"
+    PKG_CHECK_EXISTS([libavcodec >= 51.28.0],
+      [
+        AC_DEFINE(FFMPEG_AUDIO2, 1, [Define if avcodec_decode_audio2 can be used.])
+      ]
+    )
+    PKG_CHECK_EXISTS([libavcodec >= 51.49.0],
+      [
+        AC_DEFINE(FFMPEG_VP6A, 1, [Define if ffmpeg can play VP6A.])
+      ]
+    )
   else
-    AC_MSG_CHECKING([for libavcodec library])
-    topdir=""
-    for i in $libslist; do
-      if test -f $i/libavcodec.a -o -f $i/libavcodec.${shlibext}; then
-        topdir=$i
-        AC_MSG_RESULT(${topdir}/libavcodec)
-	      if test ! x"$i" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64"; then
-	        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -L$i -lavcodec"
-       	  break
-        else
-	        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lavcodec"
-	        break
-       fi
-      fi
-    done
-
-    if test x"${ac_cv_path_ffmpeg_lib}" = x; then
-      AC_MSG_RESULT(no)
-      if test x${cross_compiling} = xno; then
-        dnl avcodec_decode_audio2 starts 51.29.0
-        AC_CHECK_LIB(avcodec, ff_eval, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lavcodec"])
-      fi
-    fi
+    AC_MSG_ERROR([Cannot find libavcodec.])
   fi
 
-  if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_ffmpeg_lib}" != x; then
-    $PKG_CONFIG --exists libavcodec && topdir=`$PKG_CONFIG --libs-only-L libavcodec | sed -e 's/-L//' | cut -d ' ' -f 1`
+  PKG_CHECK_MODULES(AVFORMAT, [libavformat >= 52.22.1], [HAVE_AVFORMAT=yes], [HAVE_AVFORMAT=no])
+  if test "x$HAVE_AVFORMAT" = "xyes" ; then
+    AC_DEFINE(HAVE_LIBAVFORMAT_AVFORMAT_H, 1, [Define if avformat.h is found])
+    FFMPEG_LIBS="$FFMPEG_LIBS $AVFORMAT_LIBS"
   fi
 
-  dnl Look for the DTS library, which is required on some systems.
-  if test x"${ac_cv_path_ffmpeg_lib}" != x; then
-    AC_MSG_CHECKING([for libdts library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists libdts && libdts=`$PKG_CONFIG --libs-only-l libdts`
-    else
-      libdts=""
-    fi
-    if test x"${libdts}" = x; then
-      if test -f ${topdir}/libdts.a -o -f ${topdir}/libdts.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -ldts"
-        AC_MSG_RESULT(${topdir}/libdts)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-          AC_CHECK_LIB(dts, dts_init, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -ldts"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libdts})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libdts}"      
-    fi
-	
-    dnl Look for the VORBISENC library, which is required on some systems.
-    AC_MSG_CHECKING([for libvorbisenc library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists vorbisenc && libvorbisenc=`$PKG_CONFIG --libs-only-l vorbisenc`
-    else
-      libvorbisenc=""
-    fi
-    if test x"${libvorbisenc}" = x; then
-      if test -f ${topdir}/libvorbisenc.a -o -f ${topdir}/libvorbisenc.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lvorbisenc"
-        AC_MSG_RESULT(${topdir}/libvorbisenc)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-          AC_CHECK_LIB(vorbisenc, vorbis_encode_init, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lvorbisenc"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libvorbisenc})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libvorbisenc}"
-    fi
-	
-    dnl Look for the AVFORMAT library, which is required on some systems.
-    AC_MSG_CHECKING([for libavformat library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists libavformat && libavformat=`$PKG_CONFIG --libs-only-l libavformat`
-    else
-      libavformat=""
-    fi
-    if test x"${libavformat}" = x; then
-      if test -f ${topdir}/libavformat.a -o -f ${topdir}/libavformat.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lavformat" 
-        AC_MSG_RESULT(${topdir}/libavformat)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-          AC_CHECK_LIB(libavformat, av_open_input_file, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lavformat"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libavformat})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libavformat}"      
-    fi
-
-    dnl Look for the AVUTIL library, which is required on some systems.
-    AC_MSG_CHECKING([for libavutil library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists libavutil && libavutil=`$PKG_CONFIG --libs-only-l libavutil`
-    else
-      libavutil=""
-    fi
-    if test x"${libavutil}" = x; then
-      if test -f ${topdir}/libavutil.a -o -f ${topdir}/libavutil.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lavutil"
-        AC_MSG_RESULT(${topdir}/libavutil)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-           AC_CHECK_LIB(avutil, av_log, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lavutil"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libavutil})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libavutil}"
-    fi
-	
-    dnl Look for the THEORA library, which is required on some systems.
-    AC_MSG_CHECKING([for libtheora library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists theora && libtheora=`$PKG_CONFIG --libs-only-l theora`
-    else
-      libtheora=""
-    fi
-    if test x"${libtheora}" = x; then
-      if test -f ${topdir}/libtheora.a -o -f ${topdir}/libtheora.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -ltheora"
-        AC_MSG_RESULT(${topdir}/libtheora)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-          AC_CHECK_LIB(theora, theora_encode_init, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -ltheora"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libtheora})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libtheora}"      
-    fi
-
-    dnl Look for the GSM library, which is required on some systems.
-    AC_MSG_CHECKING([for libgsm library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists gsm && libgsm=`$PKG_CONFIG --libs-only-l gsm`
-    else
-      libgsm=""
-    fi
-
-    dnl OpenBSD seems to have a problem with libgsm.
-    if test x$openbsd_os != xopenbsd; then
-      if test x"${libgsm}" = x; then
-        if test -f ${topdir}/libgsm.a -o -f ${topdir}/libgsm.${shlibext}; then
-          ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lgsm"
-          AC_MSG_RESULT(${topdir}/libgsm)
-        else
-          AC_MSG_RESULT(no)
-          if test x${cross_compiling} = xno; then
-            AC_CHECK_LIB(gsm, gsm_destroy, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lgsm"])
-          fi
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libgsm})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libgsm}"      
-    fi
-    
-    dnl Look for the DC1394 library, which is required on some systems.
-    AC_MSG_CHECKING([for libdc1394 library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists libdc  && libdc=`$PKG_CONFIG --libs-only-l libdc1394`
-    else
-      libtdc=""
-    fi
-    if test x"${libdc}" = x; then
-      if test -f ${topdir}/libdc1394.a -o -f ${topdir}/libdc1394.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -ldc1394"
-        AC_MSG_RESULT(${topdir}/libdc1394)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-          AC_CHECK_LIB(dc1394_control, dc1394_is_camera, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -ldc1394_control"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libdc})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libdc}"
-    fi
-
-    dnl Look for the swscale library, which is required on some system if ffmpeg is
-    dnl configured with --enable-gpl --enable-swscale.
-    AC_MSG_CHECKING([for libswscale library])
-    if test x"$PKG_CONFIG" != x -a x${cross_compiling} = xno; then
-      $PKG_CONFIG --exists libswscale  && libsws=`$PKG_CONFIG --libs-only-l libswscale`
-    else
-      libsws=""
-    fi
-    if test x"${libsws}" = x; then
-      if test -f ${topdir}/libswscale.a -o -f ${topdir}/libswscale.${shlibext}; then
-        ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lswscale"
-        AC_MSG_RESULT(yes)
-      else
-        AC_MSG_RESULT(no)
-        if test x${cross_compiling} = xno; then
-          AC_CHECK_LIB(swscale, sws_scale, [ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} -lswscale"])
-        fi
-      fi
-    else
-      AC_MSG_RESULT(${libsws})
-      ac_cv_path_ffmpeg_lib="${ac_cv_path_ffmpeg_lib} ${libsws}"
-    fi
-
-  fi                            dnl end of all optional library tests
-
-  # Set final compilation flags, eliminating the pointless "-I/usr/include"
-  if test x"${ac_cv_path_ffmpeg_lib}" != x ; then
-    FFMPEG_LIBS="${ac_cv_path_ffmpeg_lib}"
+  PKG_CHECK_MODULES(SWSCALE, [libswscale >= 0.6.1], [HAVE_SWSCALE=yes], [HAVE_SWSCALE=no])
+  if test "x$HAVE_SWSCALE" = "xyes" ; then
+    AC_DEFINE(HAVE_LIBSWSCALE_SWSCALE_H, 1, [Define if swscale.h is found])
+    FFMPEG_LIBS="$FFMPEG_LIBS $SWSCALE_LIBS"
   else
-    FFMPEG_LIBS=""
+    PKG_CHECK_EXISTS([libavcodec >= 52.0.0],
+      [
+        AC_MSG_WARN([Cannot find libswscale, required for ffmpeg versions >= 52.0.0 (detected version: $ffmpeg_version)])
+      ]
+    )
   fi
 
   AC_SUBST(FFMPEG_CFLAGS)  
   AC_SUBST(FFMPEG_LIBS)
-
-  LIBS="$backupLIBS"
-  CFLAGS="$backupCFLAGS"
 ])
 
 # Local Variables:
diff -Naur gnash-0.8.4-old/macros/freetype.m4 gnash-0.8.4-new/macros/freetype.m4
--- gnash-0.8.4-old/macros/freetype.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/freetype.m4	2008-10-18 22:52:46.000000000 -0700
@@ -16,116 +16,17 @@
 
 AC_DEFUN([GNASH_PATH_FREETYPE2],
 [
-  dnl Look for the header
-  AC_ARG_WITH(freetype_incl, AC_HELP_STRING([--with-freetype-incl], [directory where libfreetype header is (w/out the freetype/ prefix)]), with_freetype_incl=${withval})
-    AC_CACHE_VAL(ac_cv_path_freetype_incl,[
-    if test x"${with_freetype_incl}" != x ; then
-      if test -f ${with_freetype_incl}/freetype/freetype.h ; then
-	      ac_cv_path_freetype_incl="-I`(cd ${with_freetype_incl}; pwd)`"
-      else
-	      AC_MSG_ERROR([${with_freetype_incl} directory doesn't contain freetype/freetype.h])
-      fi
-    fi
-  ])
-
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_freetype_incl}" = x; then
-      $PKG_CONFIG --exists freetype2 && ac_cv_path_freetype_incl="`$PKG_CONFIG --cflags freetype2`"
-    fi
-  fi
-
-  dnl If the path hasn't been specified, go look for it.
-  if test x"${ac_cv_path_freetype_incl}" = x; then
-    for i in $incllist; do
-      if test -f $i/freetype2/freetype/freetype.h; then
-        ac_cv_path_freetype_incl="-I$i/freetype2"
-	      break
-      fi
-    done
-
-    if test x"${ac_cv_path_freetype_incl}" = x ; then
-      AC_CHECK_HEADERS(freetype2/freetype/freetype.h)
-    fi
-
-    AC_MSG_CHECKING([for libfreetype header])
-    if test x"${ac_cv_path_freetype_incl}" != x ; then
-      AC_MSG_RESULT(yes)
-    else
-      AC_MSG_RESULT(no)
-    fi
-  fi
-
-
-  dnl This check is bogus, ac_cv_path_freetype_incl will have -I too, and possibly multiple things too
-  dnl so at most we can try to *strip* any -I/usr/include
-  if test x"${ac_cv_path_freetype_incl}" != x"/usr/include"; then
-    ac_cv_path_freetype_incl="${ac_cv_path_freetype_incl}"
-  else
-    ac_cv_path_freetype_incl=""
-  fi
-
-dnl   if test x"${darwin}" = xyes; then
-     libname=freetype
-dnl   else
-dnl     libname=freetype2
-dnl   fi
-  AC_ARG_WITH(freetype_lib, AC_HELP_STRING([--with-freetype-lib], [directory where freetype library is]), with_freetype_lib=${withval})
-    AC_CACHE_VAL(ac_cv_path_freetype_lib,[
-    if test x"${with_freetype_lib}" != x ; then
-      if test -f ${with_freetype_lib}/lib${libname}.a -o -f ${with_freetype_lib}/lib${libname}.${shlibext}; then
-        ac_cv_path_freetype_lib="-L`(cd ${with_freetype_lib}; pwd)` -l${libname}"
-      else
-        AC_MSG_ERROR([${with_freetype_lib} directory doesn't contain libfreetype.])
-      fi
-    fi
-  ])
-
-  dnl Look for the library
-  if test x$cross_compiling = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_freetype_lib}" = x; then
-      $PKG_CONFIG --exists freetype2 && ac_cv_path_freetype_lib="`$PKG_CONFIG --libs freetype2`"
-    fi
-  fi
-
-  dnl If the path hasn't been specified, go look for it.
-  if test x"${ac_cv_path_freetype_lib}" = x; then
-    dnl freetype-config gives us way too many libraries, which create nasty linking
-    dnl dependancy issue, so we strip them off here. The real dependencies are
-    dnl are taken care of by other config tests.
-    AC_MSG_CHECKING([for ${libname} library])
-    for i in $libslist; do
-      if test -f $i/lib${libname}.a -o -f $i/lib${libname}.${shlibext}; then
-        if test ! x"$i" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64"; then
-          ac_cv_path_freetype_lib="-L$i -l${libname}"
-          AC_MSG_RESULT(${ac_cv_path_freetype_lib})
-          break
-        else
-          ac_cv_path_freetype_lib="-l${libname}"
-          AC_MSG_RESULT(yes)
-          break
-        fi
-      fi
-    done
-  fi
+  PKG_CHECK_MODULES(FREETYPE2, freetype2, [HAVE_FREETYPE2=yes], [HAVE_FREETYPE2=no])
 
-  if test x"${ac_cv_path_freetype_incl}" != x ; then
-    FREETYPE2_CFLAGS="${ac_cv_path_freetype_incl}"
-  else
-    FREETYPE2_CFLAGS=""
-  fi
-
-  if test x"${ac_cv_path_freetype_lib}" != x ; then
-    FREETYPE2_LIBS="${ac_cv_path_freetype_lib}"
-  else
-    FREETYPE2_LIBS=""
-  fi
+  AM_CONDITIONAL(FREETYPE, [test "x$HAVE_FREETYPE2" = "xyes"])
 
-  AM_CONDITIONAL(FREETYPE, [test -n "$FREETYPE_LIBS"])
-
-  if test -n "$FREETYPE2_LIBS"; then
+  if test "x$HAVE_FREETYPE2" = "xyes" ; then
     AC_DEFINE(USE_FREETYPE, [1], [Define this if you want to enable freetype usage])
   fi
 
+  AC_SUBST(FREETYPE2_CFLAGS)
+  AC_SUBST(FREETYPE2_LIBS)
+
   dnl Look for fontconfig's fc-match to set a hard-coded font path.
   dnl If fontconfig is available, gnash should always manage to find a
   dnl suitable system font in run time, so will never need this hard-coded
@@ -142,9 +43,6 @@
   fi
   
   AC_DEFINE_UNQUOTED(DEFAULT_FONTFILE, ["$DEFAULT_FONT"], [Path to default font])
-
-  AC_SUBST(FREETYPE2_CFLAGS)
-  AC_SUBST(FREETYPE2_LIBS)
 ])
 
 # Local Variables:
diff -Naur gnash-0.8.4-old/macros/glib.m4 gnash-0.8.4-new/macros/glib.m4
--- gnash-0.8.4-old/macros/glib.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/glib.m4	2008-10-18 22:52:46.000000000 -0700
@@ -17,100 +17,10 @@
 
 AC_DEFUN([GNASH_PATH_GLIB],
 [
-    dnl Look for the header
-  AC_ARG_WITH(glib_incl, AC_HELP_STRING([--with-glib-incl], [directory where libglib header is]), with_glib_incl=${withval})
-  AC_CACHE_VAL(ac_cv_path_glib_incl,[
-    if test x"${with_glib_incl}" != x ; then
-      if test -f ${with_glib_incl}/glib.h ; then
-      	ac_cv_path_glib_incl="-I`(cd ${with_glib_incl}; pwd)`"
-      else
-    	  AC_MSG_ERROR([${with_glib_incl} directory doesn't contain glib.h])
-      fi
-    fi
-  ])
+  PKG_CHECK_MODULES(GLIB, [glib-2.0], [HAVE_GLIB=yes], [HAVE_GLIB=no])
 
-  dnl Try with pkg-config
-  if test x${cross_compiling} = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_glib_incl}" = x; then
-	    $PKG_CONFIG --exists glib-2.0 && gnash_glib_version=`$PKG_CONFIG --modversion glib-2.0`
-	    $PKG_CONFIG --exists glib-2.0 && ac_cv_path_glib_incl=`$PKG_CONFIG --cflags glib-2.0`
-    fi
-  fi
-
-  dnl Attempt to find the top level directory, which unfortunately has a
-  dnl version number attached. At least on Debain based systems, this
-  dnl doesn't seem to get a directory that is unversioned.
-  AC_MSG_CHECKING([for Glib header])  
-  if test x"${gnash_glib_version}" = x; then
-    gnash_glib_topdir=""
-    gnash_glib_version=""
-    for i in $incllist; do
-      for j in `ls -dr $i/glib-[[0-9]].[[0-9]] $i/glib/glib-[[0-9]].[[0-9]] 2>/dev/null`; do
-        if test -f $j/glib.h; then
-          gnash_glib_topdir=`basename $j`
-          gnash_glib_version=`echo ${gnash_glib_topdir} | sed -e 's:glib-::'`
-          ac_cv_path_glib_incl="-I$j"
-          gnash_glib_config=`echo $j | sed -e 's:include:lib:' -e 's:lib/glib/:lib/:'`
-          if test -f ${gnash_glib_config}/include/glibconfig.h; then
-            ac_cv_path_glib_incl="${ac_cv_path_glib_incl} -I${gnash_glib_config}/include"
-          fi
-          break
-        fi
-      done
-    done
-  fi
-      if test x"${ac_cv_path_glib_incl}" = x; then
-        AC_MSG_RESULT(no)
-	else
-        AC_MSG_RESULT(${ac_cv_path_glib_incl})	
-      fi
- 
-
-  dnl Look for the library
-  AC_ARG_WITH(glib_lib, AC_HELP_STRING([--with-glib-lib], [directory where glib library is]), with_glib_lib=${withval})
-  AC_CACHE_VAL(ac_cv_path_glib_lib,[
-    if test x"${with_glib_lib}" != x ; then
-      if test -f ${with_glib_lib}/libglib-${gnash_glib_version}.a -o -f ${with_glib_lib}/libglib-${gnash_glib_version}.${shlibext}; then
-        ac_cv_path_glib_lib="-L`(cd ${with_glib_lib}; pwd)` -lglib-${gnash_glib_version}"
-      else
-        AC_MSG_ERROR([${with_glib_lib} directory doesn't contain libglib.])
-      fi
-    fi
-  ])
-
-  if test x${cross_compiling} = xno; then
-    if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_glib_lib}" = x; then
-      $PKG_CONFIG --exists glib-2.0 && ac_cv_path_glib_lib=`$PKG_CONFIG --libs glib-2.0`
-    fi
-  fi
-
-  AC_MSG_CHECKING([for glib library])
-  if test x"${ac_cv_path_glib_lib}" = x; then
-    for i in $libslist; do
-      if test -f $i/libglib-${gnash_glib_version}.a -o -f $i/libglib-${gnash_glib_version}.${shlibext}; then
-        if test ! x"$i" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64" -a ! x"$i" = x"/usr"; then
-          ac_cv_path_glib_lib="-L$i -lglib-${gnash_glib_version}"
-          break
-        else
-          ac_cv_path_glib_lib="-lglib-${gnash_glib_version}"
-          break
-        fi
-      fi
-    done
-  fi
-  AC_MSG_RESULT(${ac_cv_path_glib_lib})
- 
-  if test x"${ac_cv_path_glib_incl}" != x; then
-	  GLIB_CFLAGS="${ac_cv_path_glib_incl} $GLIB_CFLAGS"
-	  AC_DEFINE([HAVE_GLIB], [1], [Has GLIB library installed])
-  else
-	  GLIB_CFLAGS=""
-  fi
-
-  if test x"${ac_cv_path_glib_lib}" != x ; then
-	  GLIB_LIBS="${ac_cv_path_glib_lib}"
-  else
-  	GLIB_LIBS=""
+  if test "x$HAVE_GLIB" = "xyes"; then
+    AC_DEFINE([HAVE_GLIB], [1], [Has GLIB library installed])
   fi
 
   AC_SUBST(GLIB_CFLAGS)
diff -Naur gnash-0.8.4-old/macros/gnashpkgtool.m4 gnash-0.8.4-new/macros/gnashpkgtool.m4
--- gnash-0.8.4-old/macros/gnashpkgtool.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/gnashpkgtool.m4	2008-10-18 22:52:46.000000000 -0700
@@ -61,7 +61,7 @@
 	    fi
 	  ])
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_$1_incl}" = x; then
       AC_MSG_CHECKING([for $2 header using pkg-config])
       $PKG_CONFIG --exists DOWN[] && ac_cv_path_$1_incl="`$PKG_CONFIG --cflags DOWN[]`"
@@ -185,7 +185,7 @@
 	])
 
 	dnl If the header doesn't exist, there is no point looking for the library.
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
 	  if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_$1_lib}" = x; then
 		  $PKG_CONFIG --exists libDOWN[] && ac_cv_path_$1_lib="`$PKG_CONFIG --libs-only-l libDOWN[]`"
 		  $PKG_CONFIG --exists DOWN[] && ac_cv_path_$1_lib="`$PKG_CONFIG --libs-only-l DOWN[]`"
diff -Naur gnash-0.8.4-old/macros/gtk2.m4 gnash-0.8.4-new/macros/gtk2.m4
--- gnash-0.8.4-old/macros/gtk2.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/gtk2.m4	2008-10-18 22:52:46.000000000 -0700
@@ -31,7 +31,7 @@
   ])
 
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_gtk2_incl}" = x; then
       $PKG_CONFIG --exists gtk+-2.0 && ac_cv_path_gtk2_incl="`$PKG_CONFIG --cflags gtk+-2.0`"
       $PKG_CONFIG --exists gtk+-2.0 && gnash_gtk2_version="`$PKG_CONFIG --modversion gtk+-2.0`"
@@ -86,7 +86,7 @@
     fi
   ])
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_gtk2_lib}" = x; then
       $PKG_CONFIG --exists gtk+-2.0 && ac_cv_path_gtk2_lib="`$PKG_CONFIG --libs-only-l gtk+-2.0`"
     fi
diff -Naur gnash-0.8.4-old/macros/hildon.m4 gnash-0.8.4-new/macros/hildon.m4
--- gnash-0.8.4-old/macros/hildon.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/hildon.m4	2008-10-18 22:52:46.000000000 -0700
@@ -30,7 +30,7 @@
     fi
   ])
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_hildon_incl}" = x; then
       $PKG_CONFIG --exists hildon-1 && ac_cv_path_hildon_incl="`$PKG_CONFIG --cflags-only-I hildon-1 | cut -d ' ' -f 1`"
     fi
@@ -42,7 +42,7 @@
 
   AC_MSG_CHECKING([for the Hildon Version])
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x; then
       $PKG_CONFIG --exists hildon-1 && gnash_hildon_version="`$PKG_CONFIG --modversion hildon-1 | cut -d '.' -f 1`"
     fi
@@ -87,7 +87,7 @@
     fi
   ])
   
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_hildon_lib}" = x; then
       $PKG_CONFIG --exists hildon-1 && ac_cv_path_hildon_lib="`$PKG_CONFIG --libs-only-l hildon-1 | cut -d ' ' -f 1`"
     fi
diff -Naur gnash-0.8.4-old/macros/kde.m4 gnash-0.8.4-new/macros/kde.m4
--- gnash-0.8.4-old/macros/kde.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/kde.m4	2008-10-18 22:52:46.000000000 -0700
@@ -81,7 +81,7 @@
 
   if test x"${ac_cv_path_kde_incl}" = x; then
     AC_MSG_RESULT(no)
-    if test x${cross_compiling} = xno; then
+    if test xno = xno; then
       AC_CHECK_HEADERS(kde/kapp.h, [ac_cv_path_kde_incl=""])
     fi
   else
diff -Naur gnash-0.8.4-old/macros/libXML.m4 gnash-0.8.4-new/macros/libXML.m4
--- gnash-0.8.4-old/macros/libXML.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/libXML.m4	2008-10-18 22:52:46.000000000 -0700
@@ -16,97 +16,12 @@
 
 
 AC_DEFUN([GNASH_PATH_LIBXML], [
-  has_xml=no
-  dnl Look for the header
-  AC_ARG_WITH(libxml-incl, AC_HELP_STRING([--with-libxml-incl], [directory where libxml2 header is]), with_libxml_incl=${withval})
-  AC_CACHE_VAL(ac_cv_path_libxml_incl, [
-    if test x"${with_libxml_incl}" != x ; then
-      if test -f ${with_libxml_incl}/libxml/xmlmemory.h ; then
-        ac_cv_path_libxml_incl="-I`(cd ${with_libxml_incl}; pwd)`"
-      else
-        AC_MSG_ERROR([${with_libxml_incl} directory doesn't contain libxml/xmlmemory.h])
-      fi
-    fi
-  ])
-  dnl Look for the library
-  AC_ARG_WITH(libxml_lib, AC_HELP_STRING([--with-libxml-lib], [directory where libxml2 library is]), with_libxml_lib=${withval})
-  AC_CACHE_VAL(ac_cv_path_libxml_lib, [
-    if test x"${with_libxml_lib}" != x ; then
-      if test -f ${with_libxml_libs}/libxml2.a -o -f ${with_libxml_lib}/libxml2.${shlibext}; then
-        ac_cv_path_libxml_lib="-L`(cd ${with_libxml_lib}; pwd)` -lxml2"
-      fi
-    fi
-  ])
+  PKG_CHECK_MODULES(LIBXML, libxml-2.0, [HAVE_LIBXML=yes], [HAVE_LIBXML=no])
 
-  if test x"${ac_cv_path_libxml_incl}" = x -o x"${ac_cv_path_libxml_lib}" = x; then
-    AC_PATH_PROG(XML2_CONFIG, xml2-config, ,[${pathlist}])
-    if test x"$XML2_CONFIG" != x -a x"${darwin}" = xno ; then
-      if test x"$XML2_CFLAGS" = x -a x"${ac_cv_path_libxml_incl}" = x; then
-        ac_cv_path_libxml_incl=`$XML2_CONFIG --cflags`
-      fi
-      if test x"$XML2_LIBS" = x -a x"${ac_cv_path_libxml_lib}" = x; then
-        ac_cv_path_libxml_lib=`$XML2_CONFIG --libs | sed -e 's:-L/usr/lib::'`
-      fi
-    fi
-  fi
-
-  gnash_libxml2_topdir=""
-  gnash_libxml2_version=""
-  AC_MSG_CHECKING([for libxml2 header])  
-  if test x"${ac_cv_path_libxml_incl}" = x; then
-    for i in ${incllist}; do
-      for j in `ls -dr $i/libxml2 2>/dev/null`; do
- 	      if test -f $j/libxml/xmlmemory.h; then
-      	  gnash_libxml_topdir=`basename $j`
-      	  gnash_libxml_version=`echo ${gnash_libxml2_topdir} | sed -e 's:libxml2::' -e 's:-::'`
-      	  ac_cv_path_libxml_incl="-I$j"
-          break
-        fi
-      done
-    done
-  fi
- 
-  if test x"${ac_cv_path_libxml_incl}" = x ; then
-    AC_CHECK_HEADERS(libxml/xmlmemory.h, [ac_cv_path_libxml_incl=""])
-  fi
-
-  AC_MSG_RESULT(${ac_cv_path_libxml_incl}) 
-
-  dnl AC_MSG_CHECKING([for libxml2 library])
-  if test x"${ac_cv_path_libxml_lib}" = x ; then
-    for i in $libslist; do
-      if test -f $i/libxml2.a -o -f $i/libxml2.${shlibext}; then
-        if test ! x"$i" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64"; then
-          ac_cv_path_libxml_lib="-L$i -lxml2"
-          break
-        else
-          ac_cv_path_libxml_lib="-lxml2"
-	        has_xml=yes
-          break
-        fi
-      fi
-    done
-  fi
-  if test x"${ac_cv_path_libxml_lib}" = x ; then
-    AC_CHECK_LIB(xml2, xmlInitParser, [ac_cv_path_libxml_lib="-lxml2"])
-  fi  
-
-  AC_MSG_CHECKING([for libxml2 library])
-  AC_MSG_RESULT(${ac_cv_path_libxml_lib}) 
-
-  if test x"${ac_cv_path_libxml_incl}" != x ; then
-    LIBXML_CFLAGS="${ac_cv_path_libxml_incl}"
-  else
-    LIBXML_CFLAGS=""
-  fi
-  if test x"${ac_cv_path_libxml_lib}" != x ; then
-    LIBXML_LIBS="${ac_cv_path_libxml_lib}"
-    has_xml=yes
+  if test "x$HAVE_LIBXML" = "xyes" ; then
     AC_DEFINE(HAVE_LIBXML_H, [1], [We have libxml2 support])
-  else
-    has_xml=no
-    LIBXML_LIBS=""
   fi
+
   AC_SUBST(LIBXML_CFLAGS)
   AC_SUBST(LIBXML_LIBS)
 ])
diff -Naur gnash-0.8.4-old/macros/nspr.m4 gnash-0.8.4-new/macros/nspr.m4
--- gnash-0.8.4-old/macros/nspr.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/nspr.m4	2008-10-18 22:52:46.000000000 -0700
@@ -49,7 +49,7 @@
 
   #always check to see if we have it; we only use the results if XPCOM is set.
   #if test x$nspr4 = xyes; then
-    if test x$cross_compiling = xno; then
+    if test xno = xno; then
       if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_nspr_incl}" = x; then
         $PKG_CONFIG --exists nspr && ac_cv_path_nspr_incl="`$PKG_CONFIG --cflags-only-I nspr`"
         $PKG_CONFIG --exists nspr && ac_cv_path_nspr_lib="`$PKG_CONFIG --libs nspr`"
diff -Naur gnash-0.8.4-old/macros/pango.m4 gnash-0.8.4-new/macros/pango.m4
--- gnash-0.8.4-old/macros/pango.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/pango.m4	2008-10-18 22:52:46.000000000 -0700
@@ -36,7 +36,7 @@
     pango_pkg=pangox
   fi
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_pango_incl}" = x; then
       $PKG_CONFIG --exists $pango_pkg && ac_cv_path_pango_incl="`$PKG_CONFIG --cflags $pango_pkg`"
     fi
@@ -48,7 +48,7 @@
 
   AC_MSG_CHECKING([for the Pango Version])
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x; then
       $PKG_CONFIG --exists $pango_pkg && gnash_pango_version=`$PKG_CONFIG --modversion $pango_pkg | cut -d "." -f 1 | awk '{print $'0'".0"}'`
     fi
@@ -93,7 +93,7 @@
     fi
   ])
   
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_pango_lib}" = x; then
       $PKG_CONFIG --exists $pango_pkg && ac_cv_path_pango_lib=`$PKG_CONFIG --libs-only-l $pango_pkg`
     fi
diff -Naur gnash-0.8.4-old/macros/pkg.m4 gnash-0.8.4-new/macros/pkg.m4
--- gnash-0.8.4-old/macros/pkg.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/pkg.m4	2008-10-18 22:52:46.000000000 -0700
@@ -28,7 +28,7 @@
 [m4_pattern_forbid([^_?PKG_[A-Z_]+$])
 m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
 AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])dnl
-if test x$cross_compiling = xno; then
+if test xno = xno; then
   if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
     AC_PATH_TOOL([PKG_CONFIG], [pkg-config], ,[${pathlist}])
   fi
diff -Naur gnash-0.8.4-old/macros/qt.m4 gnash-0.8.4-new/macros/qt.m4
--- gnash-0.8.4-old/macros/qt.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/qt.m4	2008-10-18 22:52:46.000000000 -0700
@@ -68,14 +68,14 @@
     fi
   fi
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x; then
       gnash_qt_version="`$PKG_CONFIG --modversion $qt_pkg | cut -d '.' -f 1`"
     fi
   fi
 
   AC_MSG_CHECKING([for qt header])
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_qt_incl}" = x; then
       $PKG_CONFIG --exists $qt_pkg && ac_cv_path_qt_incl="`$PKG_CONFIG --cflags-only-I $qt_pkg | cut -d ' ' -f 1`"
     fi
@@ -175,7 +175,7 @@
     fi
   ])
 
-  if test x$cross_compiling = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_qt_lib}" = x; then
          $PKG_CONFIG --exists $qt_pkg && ac_cv_path_qt_lib="`$PKG_CONFIG --libs-only-l $qt_pkg | cut -d ' ' -f 1`"
     fi
diff -Naur gnash-0.8.4-old/macros/sdl.m4 gnash-0.8.4-new/macros/sdl.m4
--- gnash-0.8.4-old/macros/sdl.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/sdl.m4	2008-10-18 22:52:46.000000000 -0700
@@ -28,7 +28,7 @@
       fi
     fi
   ])
-  if test x${cross_compiling} = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_sdl_incl}" = x; then
 	    $PKG_CONFIG --exists sdl && ac_cv_path_sdl_incl=`$PKG_CONFIG --cflags sdl` 
     fi
@@ -38,7 +38,7 @@
   dnl version number attached. At least on Debain based systems, this
   dnl doesn't seem to get a directory that is unversioned.
 
-  if test x${cross_compiling} = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x; then
       dnl What's the point of checking for SDL version here if we wipe out that info below ?? .. dropping the check
       dnl AC_MSG_CHECKING([for the SDL Version])  
@@ -52,13 +52,13 @@
   if test "x$SDL_CONFIG" != "x" ; then
     if test "x$SDL_CFLAGS" = "x" ; then
       SDL_CFLAGS=`$SDL_CONFIG --cflags`
-	if test x${cross_compiling} = xno; then
+	if test xno = xno; then
       		ac_cv_path_sdl_incl=$SDL_CFLAGS
 	fi
     fi
     if test "x$SDL_LIBS" = "x" ; then
       SDL_LIBS=`$SDL_CONFIG --libs | sed -e 's:-L/usr/lib\>::'`
-	if test x${cross_compiling} = xno; then
+	if test xno = xno; then
 		ac_cv_path_sdl_lib=$SDL_LIBS
 	fi
     fi
@@ -118,7 +118,7 @@
   ])
 
   SDL_LIBS=""
-  if test x${cross_compiling} = xno; then
+  if test xno = xno; then
     if test x"$PKG_CONFIG" != x -a x"${ac_cv_path_sdl_lib}" = x; then
       $PKG_CONFIG --exists sdl && ac_cv_path_sdl_lib=`$PKG_CONFIG --libs sdl`
       if test x"$ac_cv_path_sdl_lib" != x; then
diff -Naur gnash-0.8.4-old/macros/x11.m4 gnash-0.8.4-new/macros/x11.m4
--- gnash-0.8.4-old/macros/x11.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/x11.m4	2008-10-18 22:52:46.000000000 -0700
@@ -18,112 +18,52 @@
 
 AC_DEFUN([GNASH_PATH_X11],
 [
-  dnl Look for the header
-  AC_ARG_WITH(x11_incl, AC_HELP_STRING([--with-x11-incl], [Directory where x11 header is]), with_x11_incl=${withval})
-  AC_CACHE_VAL(ac_cv_path_x11_incl, [
-    if test x"${with_x11_incl}" != x ; then
-      if test -f ${with_x11_incl}/X11/X.h ; then
-       ac_cv_path_x11_incl="-I`(cd ${with_x11_incl}; pwd)`"
-      else
-       AC_MSG_ERROR([${with_x11_incl} directory doesn't contain X.h])
-      fi
-    fi
-  ])
-
-  dnl If the path hasn't been specified, go look for it.
-  if test x"${ac_cv_path_x11_incl}" = x ; then
-    newlist="/Developer/SDKs/MacOSX10.4*.sdk/usr/include ${incllist}"
-    for i in $newlist; do
-    	if test -f $i/X11/X.h; then
-  	    ac_cv_path_x11_incl="-I$i"
-    	fi
-    done
-  fi
+  X11_CFLAGS=
+  X11_LIBS=
 
-  if test x"${ac_cv_path_x11_incl}" = x ; then
-    AC_CHECK_HEADERS(X11/X.h, [ac_cv_path_x11_incl=""])
-  fi
+  PKG_CHECK_MODULES(X11, x11, [HAVE_X11=yes], [HAVE_X11=no])
 
-  AC_MSG_CHECKING([for X11 headers])
-  if test x"${ac_cv_path_x11_incl}" != x ; then
-    dnl Don't pass -I/usr/include
-    if test x"${ac_cv_path_x11_incl}" != "x-I/usr/include"; then
-      X11_CFLAGS="${ac_cv_path_x11_incl}"
+  if test "x$HAVE_X11" = "xyes" ; then
+    PKG_CHECK_MODULES(XINERAMA, xinerama, [HAVE_XINERAMA=yes], [HAVE_XINERAMA=no])
+    if test "x$HAVE_XINERAMA" = "xyes" ; then
+      X11_CFLAG="$X11_CFLAGS $XINERAMA_CFLAGS"
+      X11_LIBS="$X11_LIBS $XINERAMA_LIBS"
     fi
-    AC_MSG_RESULT(${ac_cv_path_x11_incl})
-  else
-    X11_CFLAGS=""
-    AC_MSG_RESULT(none)
-  fi
-
-  dnl Look for the library
-  AC_ARG_WITH(x11_lib, AC_HELP_STRING([--with-x11-lib], [directory where x11 library is]), with_x11_lib=${withval})
-  AC_CACHE_VAL(ac_cv_path_x11_lib,[
-    if test x"${with_x11_lib}" != x ; then
-      if test -f ${with_x11_lib}/libX11.a -o -f ${with_x11_lib}/libX11.${shlibext}; then
-       ac_cv_path_x11_lib=`(cd ${with_x11_lib}; pwd)`
-      else
-       AC_MSG_ERROR([${with_x11_lib} directory doesn't contain libx11.])
-      fi
+    PKG_CHECK_MODULES(XEXT, xext, [HAVE_XEXT=yes], [HAVE_XEXT=no])
+    if test "x$HAVE_XEXT" = "xyes" ; then
+      X11_CFLAG="$X11_CFLAGS $XEXT_CFLAGS"
+      X11_LIBS="$X11_LIBS $XEXT_LIBS"
     fi
-  ])
-
-  dnl If the header doesn't exist, there is no point looking for the library.
-  if test x"${ac_cv_path_x11_incl}" != x ; then
-    newlist="/Developer/SDKs/MacOSX10.5*.sdk/usr/lib /Developer/SDKs/MacOSX10.5*.sdk/usr/X11R6/lib /Developer/SDKs/MacOSX10.4*.sdk/usr/lib /Developer/SDKs/MacOSX10.4*.sdk/usr/X11R6/lib ${libslist}"
-    for i in $newlist; do
-      if test -f $i/libX11.a -o -f $i/libX11.${shlibext}; then
-        if test ! x"${i}" = x"/usr/lib" -a ! x"$i" = x"/usr/lib64"; then
-          ac_cv_path_x11_lib="-L$i -lX11"
-        else
-          ac_cv_path_x11_lib="-lX11"
-        fi
-        if test -f $i/libXinerama.a -o -f $i/libXinerama.${shlibext}; then
-          ac_cv_path_x11_lib="${ac_cv_path_x11_lib} -lXinerama"
-        fi
-        if test -f $i/libXext.a -o -f $i/libXext.${shlibext}; then
-          ac_cv_path_x11_lib="${ac_cv_path_x11_lib} -lXext"
-        fi
-        if test -f $i/libSM.a -o -f $i/libSM.${shlibext}; then
-          ac_cv_path_x11_lib="${ac_cv_path_x11_lib} -lSM"
-        fi
-        if test -f $i/libICE.a -o -f $i/libICE.${shlibext}; then
-         ac_cv_path_x11_lib="${ac_cv_path_x11_lib} -lICE"
-        fi
-        break
-      fi
-    done
-  fi
-
-  for i in $newlist; do
-    if test -f $i/libXplugin.a -o -f $i/libXplugin.${shlibext}; then
-      if test ! x"${i}" = x"/usr/lib" -o x"$i" = x"/usr/lib64"; then
-        ac_cv_path_x11_lib="${ac_cv_path_x11_lib} -L$i -lXplugin"
-      else
-        ac_cv_path_x11_lib="${ac_cv_path_x11_lib} -lXplugin"
-      fi
-      break
+    PKG_CHECK_MODULES(SM, sm, [HAVE_SM=yes], [HAVE_SM=no])
+    if test "x$HAVE_SM" = "xyes" ; then
+      X11_CFLAG="$X11_CFLAGS $SM_CFLAGS"
+      X11_LIBS="$X11_LIBS $SM_LIBS"
+    fi
+    PKG_CHECK_MODULES(ICE, ice, [HAVE_ICE=yes], [HAVE_ICE=no])
+    if test "x$HAVE_ICE" = "xyes" ; then
+      X11_CFLAG="$X11_CFLAGS $ICE_CFLAGS"
+      X11_LIBS="$X11_LIBS $ICE_LIBS"
     fi
-  done
-
-  if test x"${ac_cv_path_x11_lib}" = x ; then
-    AC_CHECK_LIB(X11, x11_mem_init, [ac_cv_path_x11_lib=""])
-  fi
-
-  AC_MSG_CHECKING([for X11 library])
-  if test x"${ac_cv_path_x11_lib}" != x ; then
-    X11_LIBS="${ac_cv_path_x11_lib}"
-    AC_MSG_RESULT(${ac_cv_path_x11_lib})
-  else
-    X11_LIBS=""
-    AC_MSG_RESULT(none)
   fi
 
-  if test -n "$X11_LIBS" -a -n "$X11_CFLAGS"; then
-    x11=yes
+  PKG_CHECK_MODULES(XPLUGIN, xplugin, [HAVE_XPLUGIN=yes], [HAVE_XPLUGIN=no])
+  if test "x$HAVE_XPLUGIN" = "xyes" ; then
+    HAVE_X11=yes
+    X11_CFLAG="$X11_CFLAGS $ICE_XPLUGIN"
+    X11_LIBS="$X11_LIBS $ICE_XPLUGIN"
+  fi
+
+  if test "x$HAVE_X11" = "xyes" ; then
+    AC_CHECK_LIB(X11, x11_mem_init,
+      [
+        HAVE_X11=no
+        X11_CFLAGS=
+        X11_LIBS=
+      ]
+    )
   fi
 
-  if test "x$x11" = xyes; then
+  if test "x$HAVE_X11" = xyes; then
     AC_DEFINE(HAVE_X11, [1], [X11 headers and libraries])
   fi
 
diff -Naur gnash-0.8.4-old/macros/xpcom.m4 gnash-0.8.4-new/macros/xpcom.m4
--- gnash-0.8.4-old/macros/xpcom.m4	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/macros/xpcom.m4	2008-10-18 22:52:46.000000000 -0700
@@ -57,7 +57,7 @@
     ])
 
   if test x$xpcom = xyes; then
-    if test x$cross_compiling = xno; then
+    if test xno = xno; then
 
       # Look for libxpcomglue_s.a (version 1.8 !!) if not explicitly given
       if test x$ac_cv_path_xpcom_sdk_dir = x; then
diff -Naur gnash-0.8.4-old/plugin/plugin.h gnash-0.8.4-new/plugin/plugin.h
--- gnash-0.8.4-old/plugin/plugin.h	2008-10-12 06:03:31.000000000 -0700
+++ gnash-0.8.4-new/plugin/plugin.h	2008-10-18 23:38:16.000000000 -0700
@@ -41,6 +41,9 @@
 #include <X11/Xlib.h>
 //#include <X11/Intrinsic.h>
 #include <X11/cursorfont.h>
+#ifdef HAVE_GLIB
+#include <glib.h>
+#endif
 #ifdef HAVE_GTK2
 #include <gtk/gtk.h>
 #endif
