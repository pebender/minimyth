#!/bin/sh

. /etc/minimyth.d/env.script

MM_INIT_MODE=`mm_var_get MM_INIT_MODE`
[ -z "${MM_INIT_MODE}" ] && MM_INIT_MODE="sh"

bootsplash_progress() {
    progress=$((progress + 1))
    [ -e /proc/splash ] && echo "show $(( 65535 * $progress / $progress_max ))" > /proc/splash
}

if   [ "${MM_INIT_MODE}" = "sh"   ] ; then
    progress=0
    progress_max=21
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/proc.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/bootsplash.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/modules.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/fs.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/ld.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/log.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/network.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/core.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/mythtv.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/minimyth.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/extras.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/sensors.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/acpi.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/time.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/telnet.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/web.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/mount.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/sound.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/lirc.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/mythdb.script"
    bootsplash_progress ; mm_command_run "sh /etc/minimyth.d/x.script"
elif [ "${MM_INIT_MODE}" = "make" ] ; then
    echo "init: using 'make' mode."
    mm_command_run "mount -n -t tmpfs -o size=512K tmpfs /tmp"
    mm_command_run "cp -rf /etc/rc.d /tmp/"
    mm_command_run "make -s -j64 -C /tmp/rc.d all"
    if [ -z "`mm_var_get MM_DEBUG`" ] ; then
        mm_command_run "rm -rf /tmp/rc.d"
    fi
fi

# Start X (if not debugging)
if [ -z "`mm_var_get MM_DEBUG`" ] && [ -z "`mm_var_get MM_NO_X`" ] ; then
    xinit &
fi
