#!/bin/sh

name="$1"
action="$2"

label_get()
{
    name="$1"

    label=""
    case ${name} in
        hd[a-z]*)
            label=`/lib/udev/vol_id -l /dev/${name} 2> /dev/null` || /bin/true
            ;;
        sd[a-z]*)
            label=`/lib/udev/vol_id -l /dev/${name} 2> /dev/null` || /bin/true
            ;;
    esac

    /bin/echo ${label}
}

mount_device_get()
{
    mount_point="$1"

    mount_device=
    if /usr/bin/test -r /proc/mounts ; then
        mount_device=`/bin/cat /proc/mounts | /bin/grep "^[\ ] ${mount_point}" | /usr/bin/cut -d' ' -f1`
    fi

    /bin/echo ${mount_device}
}

minimyth_add()
{
    name="$1"

    if /usr/bin/test ! -e /minimyth ; then
        /bin/mkdir -p /minimyth
        /usr/bin/logger -t minimyth -p "local0.info" "created mount point '/minimyth'."
    fi
    if /usr/bin/test -d /minimyth && /usr/bin/test -z "`mount_device_get /minimyth`" ; then
        /bin/mount -t auto /dev/${name} /minimyth || /bin/true
        /usr/bin/logger -t minimyth -p "local0.info" "mounted minimyth boot device at mount point '/minimyth'."
    fi
}

minimyth_remove()
{
    name="$1"

    if /usr/bin/test -d /minimyth ; then
        if /usr/bin/test "`mount_device_get /minimyth`" = "/dev/minimyth" ; then
            /bin/umount -l /minimyth || /bin/true
            /usr/bin/logger -t minimyth -p "local0.info" "unmounted minimyth boot device from mount point '/minimyth'."
        fi
        if /usr/bin/test -z "`mount_device_get /minimyth`" ; then
            /bin/rmdir /minimyth
            /usr/bin/logger -t minimyth -p "local0.info" "removed mount point '/minimyth'."
        fi
    fi
}

mountpoint_add()
{
    name="$1"
    symlink="$2"

    media=`/bin/echo ${symlink} | /bin/sed 's%.*/%%g'`

    if /usr/bin/test ! -e /media/${media} ; then
        /bin/mkdir -p /media/${media}
        /usr/bin/logger -t minimyth -p "local0.info" "created mount point '/media/${media}'."
    fi
    if /usr/bin/test -d /media/${media} && /usr/bin/test -z "`mount_device_get /media/${media}`" ; then
        case ${name} in
            hd[a-z])
                ;;
            sd[a-z])
                /bin/mount -t auto /dev/${symlink} /media/${media} || /bin/true
                /usr/bin/logger -t minimyth -p "local0.info" "mounted device '/dev/${symlink}' at mount point '/media/${media}'."
                ;;
            sr[0-9]*)
                ;;
        esac
    fi
}

mountpoint_remove()
{
    name="$1"
    symlink="$2"

    media=`/bin/echo ${symlink} | /bin/sed 's%.*/%%g'`

    if /usr/bin/test -d /media/${media} ; then
        if /usr/bin/test "`mount_device_get /media/${media}`" = "/dev/${symlink}" ; then
            /bin/umount -l /media/${media} || /bin/true
            /usr/bin/logger -t minimyth -p "local0.info" "unmounted device '/dev/${symlink}' from mount point '/media/${media}'."
        fi
        if /usr/bin/test -z "`mount_device_get /media/${media}`" ; then
            /bin/rmdir /media/${media}
            /usr/bin/logger -t minimyth -p "local0.info" "created mount point '/media/${media}'."
        fi
    fi
}

case ${action} in
    add)
        label=`label_get "${name}"`
        if /usr/bin/test "${label}" = "minimyth" ; then
            minimyth_add "${name}"
        else
            symlinks="${DEVLINKS}"
            for symlink in ${symlinks} ; do
                symlink=`/bin/echo ${symlink} | /bin/sed 's%//*%/%g' | /bin/sed 's%^/dev/%%'`
                mountpoint_remove "${name}" "${symlink}"
                mountpoint_add    "${name}" "${symlink}"
            done
        fi
        ;;
    remove)
        label=`label_get "${name}"`
        if /usr/bin/test "${label}" = "minimyth" ; then
            minimyth_remove "${name}"
        else
            symlinks="${DEVLINKS}"
            for symlink in ${symlinks} ; do
                symlink=`/bin/echo ${symlink} | /bin/sed 's%//*%/%g' | /bin/sed 's%^/dev/%%'`
                mountpoint_remove "${name}" "${symlink}"
            done
        fi
        ;;
esac
