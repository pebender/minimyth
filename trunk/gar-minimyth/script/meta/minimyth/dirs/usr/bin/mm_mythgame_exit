#!/bin/sh

mm_mythgame_exit_program()
{
    program="${1}"
    command="${2}"

    # Make sure that the program is running.
    if /usr/bin/test -n "`/bin/pidof ${program}`" ; then
        # Make sure that the X window manager is running, since we depend on it to select the program window.
        if /usr/bin/test -n "`/bin/pidof ratpoison`" ; then
            # Set ratpoison to select window by program name.
            /usr/bin/ratpoison -d :0.0 -c "set winname class"
            # Select the program window.
            /usr/bin/ratpoison -d :0.0 -c "select ${program}"
            # Make sure the program window is selected. 
            window=`/usr/bin/ratpoison -d :0.0 -c "info" 2> /dev/null | /bin/sed -e 's%^.*(\([^()]*\))$%\1%'`
            if /usr/bin/test "x${window}" = "x${program}" ; then
                # Send exit key sequence to window.
                /bin/echo -e "${command}" | /usr/bin/xmacroplay -d 100 :0.0 > /dev/null 2>&1
            fi
        fi
        # If the program is still running, then kill the program.
        if /usr/bin/test -n `/bin/pidof ${program}` ; then
            /usr/bin/killall zsnes > /dev/null 2>&1
        fi
    fi
}

mm_mythgame_exit_program 'fceu'             'KeyStr Escape\n'
mm_mythgame_exit_program 'jzintv'           'KeyStr F1\n'
mm_mythgame_exit_program 'stella'           'KeyStrPress Control_L\n KeyStrPress Q\n KeyStrRelease Q\n KeyStrRelease Control_L\n'
mm_mythgame_exit_program 'VisualBoyAdvance' 'KeyStr Escape\n'
mm_mythgame_exit_program 'zsnes'            'KeyStr Escape\n KeyStr Q\n KeyStr Return\n'
