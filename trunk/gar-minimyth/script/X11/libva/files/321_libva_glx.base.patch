commit 69474b0e2c2a064b771a81ff16141eb8f7c6d4b2
Author: Gwenole Beauchesne <gbeauchesne@splitted-desktop.com>
Date:   Fri Aug 21 11:58:16 2009 +0000

    Add OpenGL extensions (v3) and generic implementation with TFP and FBO.

diff --git a/Makefile.am b/Makefile.am
index 07385e6..6fb4cae 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -32,10 +32,13 @@ endif
 
 pcfiles = libva.pc
 pcfiles += libva-x11.pc
+if USE_GLX
+pcfiles += libva-glx.pc
+endif
 
 pkgconfigdir = @pkgconfigdir@
 pkgconfig_DATA = $(pcfiles)
 
-EXTRA_DIST = libva.pc.in libva-x11.pc.in
+EXTRA_DIST = libva.pc.in libva-x11.pc.in libva-glx.pc.in
 
 CLEANFILES = $(pcfiles)
diff --git a/configure.ac b/configure.ac
index 128510c..0ab5a16 100644
--- a/configure.ac
+++ b/configure.ac
@@ -66,6 +66,11 @@ LIBVA_LT_LDFLAGS="-version-info $LIBVA_LT_VERSION -release $LIBVA_VERSION.$LIBVA
 AC_SUBST(LIBVA_LT_VERSION)
 AC_SUBST(LIBVA_LT_LDFLAGS)
 
+AC_ARG_ENABLE(glx,
+              [AC_HELP_STRING([--enable-glx],
+                              [build with OpenGL for X11 support])],
+              [], [enable_glx=yes])
+
 AC_ARG_ENABLE(dummy-driver,
               [AC_HELP_STRING([--enable-dummy-driver],
                               [build dummy video driver])],
@@ -130,6 +135,22 @@ fi
 AC_DEFINE_UNQUOTED([ATTRIBUTE_HIDDEN], [$ATTRIBUTE_HIDDEN],
     [Defined to __attribute__((visibility("hidden"))) when available])
 
+# Check for OpenGL (X11)
+USE_GLX="no"
+GL_DEPS_CFLAGS=""
+GL_DEPS_LIBS=""
+if test x$enable_glx = xyes; then
+    AC_CHECK_HEADERS([GL/gl.h])
+    AC_CHECK_HEADERS([GL/glx.h])
+    AC_CHECK_LIB(GL, glXCreateContext, [
+        USE_GLX="yes"
+        GL_DEPS_LIBS="-lX11 -lGL"
+    ])
+fi
+AC_SUBST(GL_DEPS_CFLAGS)
+AC_SUBST(GL_DEPS_LIBS)
+AM_CONDITIONAL(USE_GLX, test "$USE_GLX" = "yes")
+
 # We only need the headers, we don't link against the DRM libraries
 LIBVA_CFLAGS="$DRM_CFLAGS"
 AC_SUBST(LIBVA_CFLAGS)
@@ -149,6 +170,7 @@ AC_OUTPUT([
 	src/Makefile
 	src/va_version.h
 	src/x11/Makefile
+	src/glx/Makefile
 	dummy_drv_video/Makefile
 	i965_drv_video/Makefile
 	i965_drv_video/shaders/Makefile
@@ -162,5 +184,6 @@ AC_OUTPUT([
 	test/encode/Makefile
 	libva.pc
 	libva-x11.pc
+	libva-glx.pc
 ])
 
diff --git a/libva-glx.pc.in b/libva-glx.pc.in
new file mode 100644
index 0000000..2019915
--- /dev/null
+++ b/libva-glx.pc.in
@@ -0,0 +1,12 @@
+prefix=@prefix@
+exec_prefix=@exec_prefix@
+libdir=@libdir@
+includedir=@includedir@
+display=glx
+
+Name: libva-${display}
+Description: Userspace Video Acceleration (VA) ${display} interface
+Requires: libva
+Version: @PACKAGE_VERSION@
+Libs: -L${libdir} -lva-${display}
+Cflags: -I${includedir}
diff --git a/src/Makefile.am b/src/Makefile.am
index 8063d9a..9e957b2 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -28,9 +28,17 @@ INCLUDES = \
 LDADD = \
 	$(LIBVA_LT_LDFLAGS)
 
-lib_LTLIBRARIES = \
-	libva.la \
-	libva-x11.la
+libva_x11_backend	= libva-x11.la
+libva_x11_backenddir	= x11
+if USE_GLX
+libva_glx_backend	= libva-glx.la
+libva_glx_backenddir	= glx
+else
+libva_glx_backend	=
+libva_glx_backenddir	=
+endif
+
+lib_LTLIBRARIES = libva.la $(libva_x11_backend) $(libva_glx_backend)
 
 libva_ladir = $(libdir)
 libva_la_LDFLAGS = $(LDADD) -no-undefined
@@ -41,7 +49,14 @@ libva_x11_la_LIBADD  = $(libvacorelib) x11/libva_x11.la $(LIBVA_LIBS) $(X11_LIBS
 libva_x11_la_LDFLAGS = $(LDADD)
 libva_x11_la_DEPENDENCIES = $(libvacorelib) x11/libva_x11.la
 
-SUBDIRS = x11
+libva_glx_la_SOURCES = 
+libva_glx_la_LIBADD  = $(libvacorelib) glx/libva_glx.la libva-x11.la $(GL_DEPS_LIBS) -ldl
+libva_glx_la_LDFLAGS = $(LDADD)
+libva_glx_la_DEPENDENCIES = $(libvacorelib) glx/libva_glx.la libva-x11.la
+
+SUBDIRS = $(libva_x11_backenddir) $(libva_glx_backenddir)
+
+DIST_SUBDIRS = x11 glx
 
 libva_la_SOURCES = va.c va_crystalhd.c
 
diff --git a/src/glx/Makefile.am b/src/glx/Makefile.am
new file mode 100644
index 0000000..7783d8c
diff --git a/src/glx/va_backend_glx.h b/src/glx/va_backend_glx.h
new file mode 100644
index 0000000..d110485
diff --git a/src/glx/va_glx.c b/src/glx/va_glx.c
new file mode 100644
index 0000000..2a06923
diff --git a/src/glx/va_glx.h b/src/glx/va_glx.h
new file mode 100644
index 0000000..25d2965
diff --git a/src/glx/va_glx_impl.c b/src/glx/va_glx_impl.c
new file mode 100644
index 0000000..8b1e8c3
diff --git a/src/glx/va_glx_impl.h b/src/glx/va_glx_impl.h
new file mode 100644
index 0000000..977bfcc
diff --git a/src/glx/va_glx_private.h b/src/glx/va_glx_private.h
new file mode 100644
index 0000000..e1002a6
diff --git a/src/va_backend.h b/src/va_backend.h
index d514ba0..bdc189d 100644
--- a/src/va_backend.h
+++ b/src/va_backend.h
@@ -32,9 +32,11 @@
 #ifdef IN_LIBVA
 #include "va.h"
 #include "x11/va_x11.h"
+#include "glx/va_backend_glx.h"
 #else
 #include <va/va.h>
 #include <va/va_x11.h>
+#include <va/va_backend_glx.h>
 #endif
 
 #include <stdlib.h>
@@ -372,6 +374,9 @@ struct VADriverVTable
                 unsigned int *chroma_v_offset,
                 void **buffer
         );
+
+        /* Optional: GLX support hooks */
+        struct VADriverVTableGLX glx;
 };
 
 struct VADriverContext
@@ -394,6 +399,7 @@ struct VADriverContext
     void *handle;			/* dlopen handle */
     
     void *dri_state;
+    void *glx;                          /* opaque for GLX code */
 };
 
 #define VA_DISPLAY_MAGIC 0x56414430 /* VAD0 */
@@ -416,6 +422,8 @@ struct VADisplayContext
 	VADisplayContextP ctx,
 	char **driver_name
     );
+
+    void *opaque;                       /* opaque for display extensions (e.g. GLX) */
 };
 
 typedef VAStatus (*VADriverInit) (
diff --git a/src/x11/va_x11.c b/src/x11/va_x11.c
index 297c137..d55ee62 100644
--- a/src/x11/va_x11.c
+++ b/src/x11/va_x11.c
@@ -216,6 +216,7 @@ VADisplay vaGetDisplay (
 	  pDisplayContext->vaIsValid       = va_DisplayContextIsValid;
 	  pDisplayContext->vaDestroy       = va_DisplayContextDestroy;
 	  pDisplayContext->vaGetDriverName = va_DisplayContextGetDriverName;
+          pDisplayContext->opaque          = NULL;
 	  pDisplayContexts                 = pDisplayContext;
 	  pDriverContext->dri_state 	   = dri_state;
 	  dpy                              = (VADisplay)pDisplayContext;
