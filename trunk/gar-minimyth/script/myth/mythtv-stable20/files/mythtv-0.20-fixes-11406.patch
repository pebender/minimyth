diff -Naur mythtv-0.20-old/bindings/perl/MythTV/Channel.pm mythtv-0.20-new/bindings/perl/MythTV/Channel.pm
--- mythtv-0.20-old/bindings/perl/MythTV/Channel.pm	2006-04-16 01:05:27.000000000 -0700
+++ mythtv-0.20-new/bindings/perl/MythTV/Channel.pm	2006-10-03 14:09:08.000000000 -0700
@@ -3,8 +3,8 @@
 #
 # Object containing info about a particular MythTV channel.
 #
-# @url       $URL: svn+ssh://ijr@cvs.mythtv.org/var/lib/svn/trunk/mythtv/bindings/perl/MythTV/Channel.pm $
-# @date      $Date: 2006-04-16 04:05:27 -0400 (Sun, 16 Apr 2006) $
+# @url       $URL: http://svn.mythtv.org/svn/branches/release-0-20-fixes/mythtv/bindings/perl/MythTV/Channel.pm $
+# @date      $Date: 2006-04-16 01:05:27 -0700 (Sun, 16 Apr 2006) $
 # @version   $Revision: 9725 $
 # @author    $Author: xris $
 #
diff -Naur mythtv-0.20-old/bindings/perl/MythTV/Program.pm mythtv-0.20-new/bindings/perl/MythTV/Program.pm
--- mythtv-0.20-old/bindings/perl/MythTV/Program.pm	2006-04-16 01:05:27.000000000 -0700
+++ mythtv-0.20-new/bindings/perl/MythTV/Program.pm	2006-10-03 14:09:08.000000000 -0700
@@ -3,8 +3,8 @@
 #
 # Object containing info about a particular MythTV program.
 #
-# @url       $URL: svn+ssh://ijr@cvs.mythtv.org/var/lib/svn/trunk/mythtv/bindings/perl/MythTV/Program.pm $
-# @date      $Date: 2006-04-16 04:05:27 -0400 (Sun, 16 Apr 2006) $
+# @url       $URL: http://svn.mythtv.org/svn/branches/release-0-20-fixes/mythtv/bindings/perl/MythTV/Program.pm $
+# @date      $Date: 2006-04-16 01:05:27 -0700 (Sun, 16 Apr 2006) $
 # @version   $Revision: 9725 $
 # @author    $Author: xris $
 #
diff -Naur mythtv-0.20-old/bindings/perl/MythTV/Recording.pm mythtv-0.20-new/bindings/perl/MythTV/Recording.pm
--- mythtv-0.20-old/bindings/perl/MythTV/Recording.pm	2006-07-19 19:20:17.000000000 -0700
+++ mythtv-0.20-new/bindings/perl/MythTV/Recording.pm	2006-10-03 14:09:08.000000000 -0700
@@ -3,8 +3,8 @@
 #
 # Object containing info about a particular MythTV recording.
 #
-# @url       $URL: svn+ssh://ijr@cvs.mythtv.org/var/lib/svn/trunk/mythtv/bindings/perl/MythTV/Recording.pm $
-# @date      $Date: 2006-07-19 22:20:17 -0400 (Wed, 19 Jul 2006) $
+# @url       $URL: http://svn.mythtv.org/svn/branches/release-0-20-fixes/mythtv/bindings/perl/MythTV/Recording.pm $
+# @date      $Date: 2006-07-19 19:20:17 -0700 (Wed, 19 Jul 2006) $
 # @version   $Revision: 10602 $
 # @author    $Author: xris $
 #
diff -Naur mythtv-0.20-old/bindings/perl/MythTV.pm mythtv-0.20-new/bindings/perl/MythTV.pm
--- mythtv-0.20-old/bindings/perl/MythTV.pm	2006-07-04 13:30:37.000000000 -0700
+++ mythtv-0.20-new/bindings/perl/MythTV.pm	2006-10-03 14:09:08.000000000 -0700
@@ -1,8 +1,8 @@
 #
 # MythTV bindings for perl.
 #
-# @url       $URL: svn+ssh://ijr@cvs.mythtv.org/var/lib/svn/trunk/mythtv/bindings/perl/MythTV.pm $
-# @date      $Date: 2006-07-04 16:30:37 -0400 (Tue, 04 Jul 2006) $
+# @url       $URL: http://svn.mythtv.org/svn/branches/release-0-20-fixes/mythtv/bindings/perl/MythTV.pm $
+# @date      $Date: 2006-07-04 13:30:37 -0700 (Tue, 04 Jul 2006) $
 # @version   $Revision: 10390 $
 # @author    $Author: xris $
 #
diff -Naur mythtv-0.20-old/configfiles/lircrc.native.example.mceusb2 mythtv-0.20-new/configfiles/lircrc.native.example.mceusb2
--- mythtv-0.20-old/configfiles/lircrc.native.example.mceusb2	2006-06-11 22:18:38.000000000 -0700
+++ mythtv-0.20-new/configfiles/lircrc.native.example.mceusb2	2006-10-03 14:08:47.000000000 -0700
@@ -2,7 +2,7 @@
 # lircrc config file for the Microsoft Media Center Edition Remote, model 1039
 #
 # @url       $URL$
-# @date      $Date: 2006-06-12 01:18:38 -0400 (Mon, 12 Jun 2006) $
+# @date      $Date: 2006-06-11 22:18:38 -0700 (Sun, 11 Jun 2006) $
 # @version   $Revision: 10187 $
 # @author    $Author: xris $
 #
diff -Naur mythtv-0.20-old/contrib/mythrename.pl mythtv-0.20-new/contrib/mythrename.pl
--- mythtv-0.20-old/contrib/mythrename.pl	2006-02-27 23:40:08.000000000 -0800
+++ mythtv-0.20-new/contrib/mythrename.pl	2006-10-03 14:09:08.000000000 -0700
@@ -1,6 +1,6 @@
 #!/usr/bin/perl -w
 #
-# $Date: 2006-02-28 02:40:08 -0500 (Tue, 28 Feb 2006) $
+# $Date: 2006-02-27 23:40:08 -0800 (Mon, 27 Feb 2006) $
 # $Revision: 9198 $
 # $Author: xris $
 #
diff -Naur mythtv-0.20-old/contrib/optimize_mythdb.pl mythtv-0.20-new/contrib/optimize_mythdb.pl
--- mythtv-0.20-old/contrib/optimize_mythdb.pl	2006-08-05 14:51:46.000000000 -0700
+++ mythtv-0.20-new/contrib/optimize_mythdb.pl	2006-10-03 14:09:08.000000000 -0700
@@ -1,6 +1,6 @@
 #!/usr/bin/perl -w
 #
-# $Date: 2006-08-05 17:51:46 -0400 (Sat, 05 Aug 2006) $
+# $Date: 2006-08-05 14:51:46 -0700 (Sat, 05 Aug 2006) $
 # $Revision: 10685 $
 # $Author: xris $
 #
diff -Naur mythtv-0.20-old/libs/libmyth/mythcontext.h mythtv-0.20-new/libs/libmyth/mythcontext.h
--- mythtv-0.20-old/libs/libmyth/mythcontext.h	2006-08-28 13:47:26.000000000 -0700
+++ mythtv-0.20-new/libs/libmyth/mythcontext.h	2006-10-03 14:08:56.000000000 -0700
@@ -229,7 +229,7 @@
  *   You must also update this value in
  *   mythplugins/mythweb/includes/mythbackend.php
  */
-#define MYTH_PROTO_VERSION "30"
+#define MYTH_PROTO_VERSION "31"
 
 /** \class MythContext
  *  \brief This class contains the runtime context for MythTV.
diff -Naur mythtv-0.20-old/libs/libmythdvdnav/vm.c mythtv-0.20-new/libs/libmythdvdnav/vm.c
--- mythtv-0.20-old/libs/libmythdvdnav/vm.c	2006-03-24 05:17:02.000000000 -0800
+++ mythtv-0.20-new/libs/libmythdvdnav/vm.c	2006-10-03 14:09:04.000000000 -0700
@@ -757,11 +757,11 @@
     }
   }
 
-  if((vm->state).domain == VTS_DOMAIN && !((vm->state).SPST_REG & 0x40))
+  if((vm->state).SPST_REG & 0x40)
     /* Bit 7 set means hide, and only let Forced display show */
-    return (streamN | 0x80);
+    return (streamN & 0x1F);
   else
-    return streamN;
+    return -1;
 }
 
 void vm_get_angle_info(vm_t *vm, int *current, int *num_avail) {
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/AAFilter.cpp mythtv-0.20-new/libs/libmythsoundtouch/AAFilter.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/AAFilter.cpp	2006-05-23 10:40:36.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/AAFilter.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -12,7 +12,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 13:40:36 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 10:40:36 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9996 $
 //
 // $Id: AAFilter.cpp 9996 2006-05-23 17:40:36Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/AAFilter.h mythtv-0.20-new/libs/libmythsoundtouch/AAFilter.h
--- mythtv-0.20-old/libs/libmythsoundtouch/AAFilter.h	2004-11-13 14:29:45.000000000 -0800
+++ mythtv-0.20-new/libs/libmythsoundtouch/AAFilter.h	2006-10-03 14:08:52.000000000 -0700
@@ -13,7 +13,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2004-11-13 17:29:45 -0500 (Sat, 13 Nov 2004) $
+// Last changed  : $Date: 2004-11-13 14:29:45 -0800 (Sat, 13 Nov 2004) $
 // File revision : $Revision: 4714 $
 //
 // $Id: AAFilter.h 4714 2004-11-13 22:29:45Z ijr $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/BPMDetect.h mythtv-0.20-new/libs/libmythsoundtouch/BPMDetect.h
--- mythtv-0.20-old/libs/libmythsoundtouch/BPMDetect.h	2006-05-23 10:40:36.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/BPMDetect.h	2006-10-03 14:08:52.000000000 -0700
@@ -26,7 +26,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 13:40:36 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 10:40:36 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9996 $
 //
 // $Id: BPMDetect.h 9996 2006-05-23 17:40:36Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/cpu_detect.h mythtv-0.20-new/libs/libmythsoundtouch/cpu_detect.h
--- mythtv-0.20-old/libs/libmythsoundtouch/cpu_detect.h	2006-03-16 02:00:28.000000000 -0800
+++ mythtv-0.20-new/libs/libmythsoundtouch/cpu_detect.h	2006-10-03 14:08:52.000000000 -0700
@@ -12,7 +12,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-03-16 05:00:28 -0500 (Thu, 16 Mar 2006) $
+// Last changed  : $Date: 2006-03-16 02:00:28 -0800 (Thu, 16 Mar 2006) $
 // File revision : $Revision: 9376 $
 //
 // $Id: cpu_detect.h 9376 2006-03-16 10:00:28Z ijr $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/cpu_detect_x86_gcc.cpp mythtv-0.20-new/libs/libmythsoundtouch/cpu_detect_x86_gcc.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/cpu_detect_x86_gcc.cpp	2006-05-23 10:40:36.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/cpu_detect_x86_gcc.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -12,7 +12,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 13:40:36 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 10:40:36 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9996 $
 //
 // $Id: cpu_detect_x86_gcc.cpp 9996 2006-05-23 17:40:36Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/FIFOSampleBuffer.cpp mythtv-0.20-new/libs/libmythsoundtouch/FIFOSampleBuffer.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/FIFOSampleBuffer.cpp	2006-05-23 10:40:36.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/FIFOSampleBuffer.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -15,7 +15,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 13:40:36 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 10:40:36 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9996 $
 //
 // $Id: FIFOSampleBuffer.cpp 9996 2006-05-23 17:40:36Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/FIFOSampleBuffer.h mythtv-0.20-new/libs/libmythsoundtouch/FIFOSampleBuffer.h
--- mythtv-0.20-old/libs/libmythsoundtouch/FIFOSampleBuffer.h	2006-05-23 10:40:36.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/FIFOSampleBuffer.h	2006-10-03 14:08:52.000000000 -0700
@@ -15,7 +15,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 13:40:36 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 10:40:36 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9996 $
 //
 // $Id: FIFOSampleBuffer.h 9996 2006-05-23 17:40:36Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/FIFOSamplePipe.h mythtv-0.20-new/libs/libmythsoundtouch/FIFOSamplePipe.h
--- mythtv-0.20-old/libs/libmythsoundtouch/FIFOSamplePipe.h	2005-05-23 13:39:12.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/FIFOSamplePipe.h	2006-10-03 14:08:52.000000000 -0700
@@ -17,7 +17,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2005-05-23 16:39:12 -0400 (Mon, 23 May 2005) $
+// Last changed  : $Date: 2005-05-23 13:39:12 -0700 (Mon, 23 May 2005) $
 // File revision : $Revision: 6468 $
 //
 // $Id: FIFOSamplePipe.h 6468 2005-05-23 20:39:12Z ijr $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/FIRFilter.cpp mythtv-0.20-new/libs/libmythsoundtouch/FIRFilter.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/FIRFilter.cpp	2006-03-31 22:19:12.000000000 -0800
+++ mythtv-0.20-new/libs/libmythsoundtouch/FIRFilter.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -11,7 +11,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-04-01 01:19:12 -0500 (Sat, 01 Apr 2006) $
+// Last changed  : $Date: 2006-03-31 22:19:12 -0800 (Fri, 31 Mar 2006) $
 // File revision : $Revision: 9588 $
 //
 // $Id: FIRFilter.cpp 9588 2006-04-01 06:19:12Z ijr $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/FIRFilter.h mythtv-0.20-new/libs/libmythsoundtouch/FIRFilter.h
--- mythtv-0.20-old/libs/libmythsoundtouch/FIRFilter.h	2004-11-13 14:29:45.000000000 -0800
+++ mythtv-0.20-new/libs/libmythsoundtouch/FIRFilter.h	2006-10-03 14:08:52.000000000 -0700
@@ -11,7 +11,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2004-11-13 17:29:45 -0500 (Sat, 13 Nov 2004) $
+// Last changed  : $Date: 2004-11-13 14:29:45 -0800 (Sat, 13 Nov 2004) $
 // File revision : $Revision: 4714 $
 //
 // $Id: FIRFilter.h 4714 2004-11-13 22:29:45Z ijr $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/mmx_gcc.cpp mythtv-0.20-new/libs/libmythsoundtouch/mmx_gcc.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/mmx_gcc.cpp	2006-05-23 12:14:24.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/mmx_gcc.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -15,7 +15,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 15:14:24 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 12:14:24 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9998 $
 //
 // $Id: mmx_gcc.cpp 9998 2006-05-23 19:14:24Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/RateTransposer.cpp mythtv-0.20-new/libs/libmythsoundtouch/RateTransposer.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/RateTransposer.cpp	2006-05-23 12:14:24.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/RateTransposer.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -10,7 +10,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 15:14:24 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 12:14:24 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9998 $
 //
 // $Id: RateTransposer.cpp 9998 2006-05-23 19:14:24Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/RateTransposer.h mythtv-0.20-new/libs/libmythsoundtouch/RateTransposer.h
--- mythtv-0.20-old/libs/libmythsoundtouch/RateTransposer.h	2004-11-13 14:29:45.000000000 -0800
+++ mythtv-0.20-new/libs/libmythsoundtouch/RateTransposer.h	2006-10-03 14:08:52.000000000 -0700
@@ -14,7 +14,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2004-11-13 17:29:45 -0500 (Sat, 13 Nov 2004) $
+// Last changed  : $Date: 2004-11-13 14:29:45 -0800 (Sat, 13 Nov 2004) $
 // File revision : $Revision: 4714 $
 //
 // $Id: RateTransposer.h 4714 2004-11-13 22:29:45Z ijr $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/SoundTouch.cpp mythtv-0.20-new/libs/libmythsoundtouch/SoundTouch.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/SoundTouch.cpp	2006-05-24 03:48:15.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/SoundTouch.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -41,7 +41,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-24 06:48:15 -0400 (Wed, 24 May 2006) $
+// Last changed  : $Date: 2006-05-24 03:48:15 -0700 (Wed, 24 May 2006) $
 // File revision : $Revision: 10003 $
 //
 // $Id: SoundTouch.cpp 10003 2006-05-24 10:48:15Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/SoundTouch.h mythtv-0.20-new/libs/libmythsoundtouch/SoundTouch.h
--- mythtv-0.20-old/libs/libmythsoundtouch/SoundTouch.h	2006-05-23 10:40:36.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/SoundTouch.h	2006-10-03 14:08:52.000000000 -0700
@@ -41,7 +41,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 13:40:36 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 10:40:36 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9996 $
 //
 // $Id: SoundTouch.h 9996 2006-05-23 17:40:36Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/STTypes.h mythtv-0.20-new/libs/libmythsoundtouch/STTypes.h
--- mythtv-0.20-old/libs/libmythsoundtouch/STTypes.h	2006-05-24 07:56:37.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/STTypes.h	2006-10-03 14:08:52.000000000 -0700
@@ -8,7 +8,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-24 10:56:37 -0400 (Wed, 24 May 2006) $
+// Last changed  : $Date: 2006-05-24 07:56:37 -0700 (Wed, 24 May 2006) $
 // File revision : $Revision: 10005 $
 //
 // $Id: STTypes.h 10005 2006-05-24 14:56:37Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/TDStretch.cpp mythtv-0.20-new/libs/libmythsoundtouch/TDStretch.cpp
--- mythtv-0.20-old/libs/libmythsoundtouch/TDStretch.cpp	2006-05-23 12:14:24.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/TDStretch.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -13,7 +13,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 15:14:24 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 12:14:24 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9998 $
 //
 // $Id: TDStretch.cpp 9998 2006-05-23 19:14:24Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythsoundtouch/TDStretch.h mythtv-0.20-new/libs/libmythsoundtouch/TDStretch.h
--- mythtv-0.20-old/libs/libmythsoundtouch/TDStretch.h	2006-05-23 12:14:24.000000000 -0700
+++ mythtv-0.20-new/libs/libmythsoundtouch/TDStretch.h	2006-10-03 14:08:52.000000000 -0700
@@ -13,7 +13,7 @@
 ///
 ////////////////////////////////////////////////////////////////////////////////
 //
-// Last changed  : $Date: 2006-05-23 15:14:24 -0400 (Tue, 23 May 2006) $
+// Last changed  : $Date: 2006-05-23 12:14:24 -0700 (Tue, 23 May 2006) $
 // File revision : $Revision: 9998 $
 //
 // $Id: TDStretch.h 9998 2006-05-23 19:14:24Z danielk $
diff -Naur mythtv-0.20-old/libs/libmythtv/avformatdecoder.cpp mythtv-0.20-new/libs/libmythtv/avformatdecoder.cpp
--- mythtv-0.20-old/libs/libmythtv/avformatdecoder.cpp	2006-09-03 20:50:52.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/avformatdecoder.cpp	2006-10-03 14:08:51.000000000 -0700
@@ -464,9 +464,13 @@
 void AvFormatDecoder::SeekReset(long long newKey, uint skipFrames,
                                 bool doflush, bool discardFrames)
 {
-    if (ringBuffer->InDVDMenuOrStillFrame())
-        return;
-
+    if (ringBuffer->isDVD())
+    {
+        if (ringBuffer->InDVDMenuOrStillFrame() ||
+            newKey == 0) 
+            return;
+    }
+            
     VERBOSE(VB_PLAYBACK, LOC +
             QString("SeekReset(%1, %2, %3 flush, %4 discard)")
             .arg(newKey).arg(skipFrames)
@@ -1497,20 +1501,22 @@
                 trackNo = GetTrackCount(kTrackTypeAudio) - 1;
             SetTrack(kTrackTypeAudio, trackNo);
         }
-        if (tracks[kTrackTypeSubtitle].size() > 1)
+        if (tracks[kTrackTypeSubtitle].size() > 0)
         {
             qBubbleSort(tracks[kTrackTypeSubtitle]);
             int trackNo = ringBuffer->DVD()->GetTrack(kTrackTypeSubtitle);
             uint captionmode = GetNVP()->GetCaptionMode();
-            if (captionmode == kDisplayAVSubtitle) {
-                if (trackNo < 0 || trackNo >= (int)GetTrackCount(kTrackTypeSubtitle))
-                {
-                    GetNVP()->SetCaptionsEnabled(false, false);
-                }
-                else
+            if (captionmode == kDisplayAVSubtitle &&
+                (trackNo < 0 || trackNo >= (int)GetTrackCount(kTrackTypeSubtitle)))
+            {
+                GetNVP()->SetCaptionsEnabled(false, false);
+            }
+            else
+            {
+                if (!ringBuffer->InDVDMenuOrStillFrame() && trackNo >= 0)
                 {
-                    if (!ringBuffer->InDVDMenuOrStillFrame() && trackNo >= 0)
-                        GetNVP()->SetCaptionsEnabled(true, false);
+                    SetTrack(kTrackTypeSubtitle, trackNo);
+                    GetNVP()->SetCaptionsEnabled(true, false);
                 }
             }
         }
diff -Naur mythtv-0.20-old/libs/libmythtv/channelutil.cpp mythtv-0.20-new/libs/libmythtv/channelutil.cpp
--- mythtv-0.20-old/libs/libmythtv/channelutil.cpp	2006-08-23 17:52:42.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/channelutil.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -1435,64 +1435,43 @@
     if (it == sorted.end())
         return 0; // no channels..
 
+    DBChanList::const_iterator start = it;
     bool skip_non_visible = true; // TODO make DB selectable
-    if (skip_non_visible)
+
+    if (CHANNEL_DIRECTION_DOWN == direction)
     {
-        DBChanList::const_iterator start = it;
-        if (CHANNEL_DIRECTION_DOWN == direction)
-        {
-            do
-            {
-                if (it == sorted.begin())
-                {
-                    it = find(sorted.begin(), sorted.end(),
-                              sorted.rbegin()->chanid);
-                }
-                else
-                {
-                    it--;
-                }
-            } while ((it != start) && !it->visible);
-        }
-        else if (CHANNEL_DIRECTION_UP == direction)
+        do
         {
-            do
-            {
-                it++;
-                it = (it == sorted.end()) ? sorted.begin() : it;
-            } while ((it != start) && !it->visible);
-        }
-    }
-    else if (CHANNEL_DIRECTION_DOWN == direction)
-    {
-        if (it == sorted.begin())
-            return sorted.rbegin()->chanid;
-        it--;
+            if (it == sorted.begin())
+                it = find(sorted.begin(), sorted.end(),
+                          sorted.rbegin()->chanid);
+            else
+                it--;
+        } while ((it != start) && skip_non_visible && !it->visible);
+
     }
     else if (CHANNEL_DIRECTION_UP == direction)
     {
-        it++;
-        it = (it == sorted.end()) ? sorted.begin() : it;
+        do
+        {
+            it++;
+            if (it == sorted.end())
+                it = sorted.begin();
+        } while ((it != start) && skip_non_visible && !it->visible);
     }
     else if (CHANNEL_DIRECTION_FAVORITE == direction)
     {
-        DBChanList::const_iterator it_orig = it;
-        for (;;++it)
+        do
         {
-            it = (it == sorted.end()) ? sorted.begin() : it;
+            it++;
+            if (it == sorted.end())
+                it = sorted.begin();
 
-            if (it == it_orig)
-            {
-                if (!it->favorite)
-                    ++it;
-                it = (it == sorted.end()) ? sorted.begin() : it;
-                break; // no (other?) favorites
-            }
-
-            if (it->favorite)
-                break; // found next favorite
-        }
+        } while ((it != start) &&
+                 (!it->favorite || (skip_non_visible && !it->visible)));
     }
 
     return it->chanid;
 }
+
+/* vim: set expandtab tabstop=4 shiftwidth=4: */
diff -Naur mythtv-0.20-old/libs/libmythtv/dbcheck.cpp mythtv-0.20-new/libs/libmythtv/dbcheck.cpp
--- mythtv-0.20-old/libs/libmythtv/dbcheck.cpp	2006-09-10 21:35:19.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/dbcheck.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -10,7 +10,7 @@
 #include "mythdbcon.h"
 
 /// This is the DB schema version expected by the running MythTV instance.
-const QString currentDatabaseVersion = "1158";
+const QString currentDatabaseVersion = "1160";
 
 static bool UpdateDBVersionNumber(const QString &newnumber);
 static bool performActualUpdate(const QString updates[], QString version,
@@ -2510,6 +2510,41 @@
             return false;
     }
 
+    if (dbver == "1158")
+    {
+        const QString updates[] = {
+"ALTER TABLE recorded ADD COLUMN watched TINYINT NOT NULL DEFAULT '0';",
+""
+};
+
+        if (!performActualUpdate(updates, "1159", dbver))
+            return false;
+    }
+
+    if (dbver == "1159")
+    {
+        MSqlQuery query(MSqlQuery::InitCon());
+        query.prepare("SELECT DISTINCT chanid, starttime FROM recordedmarkup "
+                      "WHERE type = 1;");
+        if (query.exec() && query.isActive() && query.size() > 0)
+        {
+            MSqlQuery fixup(MSqlQuery::InitCon());
+            while (query.next())
+            {
+                fixup.prepare(
+                       "UPDATE recorded SET cutlist = 1 "
+                       "WHERE chanid = :CHANID AND starttime =  :STARTTIME;");
+                fixup.bindValue(":CHANID", query.value(0).toString());
+                fixup.bindValue(":STARTTIME", query.value(1).toDateTime());
+
+                fixup.exec();
+            }
+        }
+
+        const QString updates[] = { "" };
+        if (!performActualUpdate(updates, "1160", dbver))
+            return false;
+    }
 
 //"ALTER TABLE capturecard DROP COLUMN dvb_recordts;" in 0.21
 //"ALTER TABLE capturecard DROP COLUMN dvb_hw_decoder;" in 0.21
diff -Naur mythtv-0.20-old/libs/libmythtv/diseqc.cpp mythtv-0.20-new/libs/libmythtv/diseqc.cpp
--- mythtv-0.20-old/libs/libmythtv/diseqc.cpp	2006-08-08 08:48:57.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/diseqc.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -450,7 +450,7 @@
     ApplyVoltage(settings, tuning);
 
     // turn off tone burst first if commands need to be sent
-    if (m_root->IsCommandNeeded(settings))
+    if (m_root->IsCommandNeeded(settings, tuning))
     {
         SetTone(false);
         usleep(DISEQC_SHORT_WAIT);
@@ -969,41 +969,40 @@
     if (pos < 0)
         return false;
 
-    // determine if switch command needs to be sent based on last pos
-    if ((m_last_pos == (uint)pos) && m_children[pos])
-        return m_children[pos]->Execute(settings, tuning);
-
     // perform switching
-    switch (m_type)
+    if (ShouldSwitch(settings, tuning))
     {
-        case kTypeTone:
-            success = ExecuteTone(settings, tuning, pos);
-            break;
-        case kTypeDiSEqCCommitted:
-        case kTypeDiSEqCUncommitted:
-            success = ExecuteDiseqc(settings, tuning, pos);
-            break;
-        case kTypeLegacySW21:
-        case kTypeLegacySW42:
-        case kTypeLegacySW64:
-            success = ExecuteLegacy(settings, tuning, pos);
-            break;
-        default:
-            success = false;
-            VERBOSE(VB_IMPORTANT, LOC_ERR +
-                    QString("Unknown switch type (%1)")
-                    .arg((uint)m_type));
-            break;
-    }
+        switch (m_type)
+        {
+            case kTypeTone:
+                success = ExecuteTone(settings, tuning, pos);
+                break;
+            case kTypeDiSEqCCommitted:
+            case kTypeDiSEqCUncommitted:
+                success = ExecuteDiseqc(settings, tuning, pos);
+                break;
+            case kTypeLegacySW21:
+            case kTypeLegacySW42:
+            case kTypeLegacySW64:
+                success = ExecuteLegacy(settings, tuning, pos);
+                break;
+            default:
+                success = false;
+                VERBOSE(VB_IMPORTANT, LOC_ERR +
+                        QString("Unknown switch type (%1)")
+                        .arg((uint)m_type));
+                break;
+        }
 
-    // if a child device will be sending a diseqc command, wait 100ms
-    if (m_children[pos]->IsCommandNeeded(settings))
-    {
-        VERBOSE(VB_CHANNEL, LOC + "Waiting for switch");
-        usleep(DISEQC_LONG_WAIT);
-    }
+        // if a child device will be sending a diseqc command, wait 100ms
+        if (m_children[pos]->IsCommandNeeded(settings, tuning))
+        {
+            VERBOSE(VB_CHANNEL, LOC + "Waiting for switch");
+            usleep(DISEQC_LONG_WAIT);
+        }
 
-    m_last_pos = pos;
+        m_last_pos = pos;
+    }
 
     // chain to child if the switch was successful
     if (success)
@@ -1015,6 +1014,8 @@
 void DiSEqCDevSwitch::Reset(void)
 {
     m_last_pos = (uint) -1;
+    m_last_high_band = (uint) -1;
+    m_last_horizontal = (uint) -1;
     dvbdev_vec_t::iterator it = m_children.begin();
     for (; it != m_children.end(); ++it)
     {
@@ -1023,19 +1024,15 @@
     }
 }
 
-bool DiSEqCDevSwitch::IsCommandNeeded(const DiSEqCDevSettings &settings) const
+bool DiSEqCDevSwitch::IsCommandNeeded(const DiSEqCDevSettings &settings,
+                                      const DVBTuning         &tuning) const
 {
-    // sanity check switch position
     int pos = GetPosition(settings);
     if (pos < 0)
         return false;
 
-    // if position is changing, a command is definitely needed
-    if ((uint)pos != m_last_pos)
-        return true;
-
-    // otherwise, the child that will be selected may need a command
-    return m_children[pos]->IsCommandNeeded(settings);
+    return (ShouldSwitch(settings, tuning) ||
+            m_children[pos]->IsCommandNeeded(settings, tuning));
 }
 
 DiSEqCDevDevice *DiSEqCDevSwitch::GetSelectedChild(const DiSEqCDevSettings &settings) const
@@ -1348,6 +1345,34 @@
     return false;
 }
 
+bool DiSEqCDevSwitch::ShouldSwitch(const DiSEqCDevSettings &settings,
+                                   const DVBTuning &tuning) const
+{
+    int pos = GetPosition(settings);
+    if (pos < 0)
+        return false;
+
+    // committed switch should change for band and polarity as well
+    if (kTypeDiSEqCCommitted == m_type)
+    {
+        // retrieve LNB info
+        bool high_band  = false;
+        bool horizontal = false;
+        DiSEqCDevLNB *lnb  = m_tree.FindLNB(settings);
+        if (lnb)
+        {
+            high_band   = lnb->IsHighBand(tuning);
+            horizontal  = lnb->IsHorizontal(tuning);
+        }
+
+        if(high_band != m_last_high_band ||
+           horizontal != m_last_horizontal)
+            return true;
+    }
+
+    return m_last_pos != (uint)pos;
+}
+
 bool DiSEqCDevSwitch::ExecuteDiseqc(const DiSEqCDevSettings &settings,
                                     const DVBTuning &tuning,
                                     uint pos)
@@ -1385,7 +1410,13 @@
     VERBOSE(VB_CHANNEL, LOC + "Changing to DiSEqC switch port " +
             QString("%1/%2").arg(pos + 1).arg(m_num_ports));
 
-    return m_tree.SendCommand(DISEQC_ADR_SW_ALL, cmd, m_repeat, 1, &data);
+    bool ret = m_tree.SendCommand(DISEQC_ADR_SW_ALL, cmd, m_repeat, 1, &data);
+    if(ret)
+    {
+        m_last_high_band = high_band;
+        m_last_horizontal = horizontal;
+    }
+    return ret;
 }
 
 int DiSEqCDevSwitch::GetPosition(const DiSEqCDevSettings &settings) const
@@ -1490,7 +1521,8 @@
         m_child->Reset();
 }
 
-bool DiSEqCDevRotor::IsCommandNeeded(const DiSEqCDevSettings &settings) const
+bool DiSEqCDevRotor::IsCommandNeeded(const DiSEqCDevSettings &settings,
+                                     const DVBTuning         &tuning) const
 {
     double position = settings.GetValue(GetDeviceID());
 
@@ -1498,7 +1530,7 @@
         return true;
 
     if (m_child)
-        return m_child->IsCommandNeeded(settings);
+        return m_child->IsCommandNeeded(settings, tuning);
 
     return false;
 }
@@ -1528,15 +1560,20 @@
     return true;
 }
 
-uint DiSEqCDevRotor::GetVoltage(const DiSEqCDevSettings &settings,
-                                const DVBTuning         &tuning) const
+bool DiSEqCDevRotor::IsMoving(const DiSEqCDevSettings &settings) const
 {
     double position = settings.GetValue(GetDeviceID());
     double completed = GetProgress();
     bool   moving   = (completed < 1.0) || (position != m_last_position);
 
+    return (m_last_pos_known && moving);
+}
+
+uint DiSEqCDevRotor::GetVoltage(const DiSEqCDevSettings &settings,
+                                const DVBTuning         &tuning) const
+{
     // override voltage if the last position is known and the rotor is moving
-    if (m_last_pos_known && moving)
+    if (IsMoving(settings))
     {
         VERBOSE(VB_CHANNEL, LOC +
                 "Overriding voltage to 18V for faster rotor movement");
diff -Naur mythtv-0.20-old/libs/libmythtv/diseqc.h mythtv-0.20-new/libs/libmythtv/diseqc.h
--- mythtv-0.20-old/libs/libmythtv/diseqc.h	2006-07-18 09:18:43.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/diseqc.h	2006-10-03 14:08:52.000000000 -0700
@@ -159,7 +159,8 @@
     QString       GetDescription(void) const { return m_desc;        }
     virtual uint  GetChildCount(void)  const { return 0;             }
     virtual bool  IsCommandNeeded(
-        const DiSEqCDevSettings&)      const { return false;         }
+        const DiSEqCDevSettings&, const DVBTuning&)
+                                       const { return false;         }
     virtual uint  GetVoltage(
         const DiSEqCDevSettings&, const DVBTuning&) const = 0;
 
@@ -230,8 +231,11 @@
     // Gets
     dvbdev_switch_t GetType(void)       const { return m_type;      }
     uint            GetNumPorts(void)   const { return m_num_ports; }
+    bool            ShouldSwitch(const DiSEqCDevSettings &settings,
+                                 const DVBTuning &tuning) const;
     virtual uint    GetChildCount(void) const;
-    virtual bool    IsCommandNeeded(const DiSEqCDevSettings&) const;
+    virtual bool    IsCommandNeeded(const DiSEqCDevSettings&,
+                                    const DVBTuning&) const;
     virtual uint    GetVoltage(const DiSEqCDevSettings&,
                                const DVBTuning&) const;
 
@@ -257,6 +261,8 @@
     dvbdev_switch_t m_type;
     uint            m_num_ports;
     uint            m_last_pos;
+    uint            m_last_high_band;
+    uint            m_last_horizontal;
     dvbdev_vec_t    m_children;
 
     static const TypeTable SwitchTypeTable[7];
@@ -291,7 +297,9 @@
     double         GetProgress(void)     const;
     bool           IsPositionKnown(void) const;
     virtual uint   GetChildCount(void)   const { return 1;           }
-    virtual bool   IsCommandNeeded(const DiSEqCDevSettings&) const;
+    virtual bool   IsCommandNeeded(const DiSEqCDevSettings&,
+                                   const DVBTuning&) const;
+    bool           IsMoving(const DiSEqCDevSettings&) const;
     virtual uint   GetVoltage(const DiSEqCDevSettings&,
                               const DVBTuning&) const;
 
diff -Naur mythtv-0.20-old/libs/libmythtv/DVDRingBuffer.cpp mythtv-0.20-new/libs/libmythtv/DVDRingBuffer.cpp
--- mythtv-0.20-old/libs/libmythtv/DVDRingBuffer.cpp	2006-08-28 10:11:08.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/DVDRingBuffer.cpp	2006-10-03 14:08:51.000000000 -0700
@@ -315,7 +315,7 @@
                 ClearSubtitlesOSD();
 
                 if (autoselectsubtitle)
-                    curSubtitleTrack = dvdnav_get_active_spu_stream(dvdnav) & 0x1F;
+                    curSubtitleTrack = dvdnav_get_active_spu_stream(dvdnav);
 
                 if (parent)
                 {
diff -Naur mythtv-0.20-old/libs/libmythtv/DVDRingBuffer.h mythtv-0.20-new/libs/libmythtv/DVDRingBuffer.h
--- mythtv-0.20-old/libs/libmythtv/DVDRingBuffer.h	2006-08-08 12:05:25.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/DVDRingBuffer.h	2006-10-03 14:08:52.000000000 -0700
@@ -147,7 +147,7 @@
     /// menu pkt pts is not reliable
     long long      menupktpts;
     int            curAudioTrack;
-    int            curSubtitleTrack;
+    int8_t         curSubtitleTrack;
     bool           autoselectaudio;
     bool           autoselectsubtitle;
     const char     *dvdname;
diff -Naur mythtv-0.20-old/libs/libmythtv/eithelper.cpp mythtv-0.20-new/libs/libmythtv/eithelper.cpp
--- mythtv-0.20-old/libs/libmythtv/eithelper.cpp	2006-07-18 03:25:23.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/eithelper.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -215,6 +215,9 @@
     fix |= fixup[(((uint64_t)eit->TSID()) << 32) |
                  (eit->OriginalNetworkID() << 16)];
     fix |= fixup[(eit->OriginalNetworkID() << 16) | eit->ServiceID()];
+    fix |= fixup[(((uint64_t)eit->TSID()) << 32) |
+                 (uint64_t)(eit->OriginalNetworkID() << 16) |
+		 (uint64_t)eit->ServiceID()];
     fix |= EITFixUp::kFixGenericDVB;
 
     uint networkid = eit->OriginalNetworkID();
@@ -515,9 +518,36 @@
     fix[ 4096 << 16] = EITFixUp::kFixAUStar;
     fix[ 4096 << 16] = EITFixUp::kFixAUStar;
 
-    fix[ 769LL << 32 | 8468 << 16] = EITFixUp::kEFixPro7Sat; // DVB-T Berlin
-    fix[3075LL << 32 | 8468 << 16] = EITFixUp::kEFixPro7Sat; // DVB-T Bremen
-    fix[                133 << 16] = EITFixUp::kEFixPro7Sat; // Premiere and pro7/Sat.1 
+    fix[  769LL << 32 | 8468 << 16] = EITFixUp::kEFixPro7Sat; // DVB-T Berlin
+    fix[ 3075LL << 32 | 8468 << 16] = EITFixUp::kEFixPro7Sat; // DVB-T Bremen
+    fix[ 8705LL << 32 | 8468 << 16] = EITFixUp::kEFixPro7Sat; // DVB-T Hessen
+    fix[13057LL << 32 | 8468 << 16] = EITFixUp::kEFixPro7Sat; // DVB-T Munich
+
+    // DVB-C germany: Kabel Deutschland encoding fixes
+    fix[   112LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10000LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10001LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10002LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10003LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10004LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10005LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10006LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10008LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    fix[ 10009LL << 32 | 61441U << 16] = EITFixUp::kEFixPro7Sat;
+    // on the multiplex with RTL only following channels must be fixed
+    fix[ 10007LL << 32 | 61441U << 16 | 53605] = EITFixUp::kEFixPro7Sat; //terranova
+    fix[ 10007LL << 32 | 61441U << 16 | 53607] = EITFixUp::kEFixPro7Sat; //Eurosport
+    fix[ 10007LL << 32 | 61441U << 16 | 53608] = EITFixUp::kEFixPro7Sat; //Das Vierte
+    fix[ 10007LL << 32 | 61441U << 16 | 53609] = EITFixUp::kEFixPro7Sat; //Viva
+
+    fix[ 774LL << 32 | 8468 << 16 | 16392] = EITFixUp::kEFixPro7Sat; //DVB-T Berlin dsf
+    fix[1082LL << 32 |    1 << 16 | 20001] = EITFixUp::kEFixPro7Sat; //DVB-S Pro7 Swiss
+    fix[1082LL << 32 |    1 << 16 | 20002] = EITFixUp::kEFixPro7Sat; //DVB-S Pro7 Austria
+    fix[1082LL << 32 |    1 << 16 | 20003] = EITFixUp::kEFixPro7Sat; //DVB-S Kabel1 Swiss
+    fix[1082LL << 32 |    1 << 16 | 20004] = EITFixUp::kEFixPro7Sat; //DVB-S Kabel1 Austria
+    fix[1082LL << 32 |    1 << 16 | 20005] = EITFixUp::kEFixPro7Sat; //DVB-S Sat.1 Austria
+
+    fix[ 133 << 16] = EITFixUp::kEFixPro7Sat; // Premiere and Pro7/Sat.1
 }
 
 static int calc_eit_utc_offset(void)
diff -Naur mythtv-0.20-old/libs/libmythtv/firewirerecorder.cpp mythtv-0.20-new/libs/libmythtv/firewirerecorder.cpp
--- mythtv-0.20-old/libs/libmythtv/firewirerecorder.cpp	2006-06-07 16:29:38.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/firewirerecorder.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -25,7 +25,7 @@
 const int FirewireRecorder::kBroadcastChannel    = 63;
 const int FirewireRecorder::kConnectionP2P       = 0;
 const int FirewireRecorder::kConnectionBroadcast = 1;
-const uint FirewireRecorder::kMaxBufferedPackets = 8000;
+const uint FirewireRecorder::kMaxBufferedPackets = 2000;
 
 // callback function for libiec61883
 int fw_tspacket_handler(unsigned char *tspacket, int /*len*/,
diff -Naur mythtv-0.20-old/libs/libmythtv/mpeg/dvbdescriptors.h mythtv-0.20-new/libs/libmythtv/mpeg/dvbdescriptors.h
--- mythtv-0.20-old/libs/libmythtv/mpeg/dvbdescriptors.h	2006-08-10 14:23:33.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/mpeg/dvbdescriptors.h	2006-10-03 14:08:50.000000000 -0700
@@ -618,7 +618,7 @@
     uint Modulation() const { return _data[8]&0x1f; }
     QString ModulationString() const
     {
-        static QString ms[] = { "qpsk", "qpsk", "qpsk_8", "qam_16" };
+        static QString ms[] = { "qpsk", "qpsk", "8psk", "qam_16" };
         return (Modulation() <= kModulationQAM16) ? ms[Modulation()] : "auto";
     }
     // symbol_rate             28   9.0
@@ -1160,6 +1160,20 @@
         kServiceTypeRCS_FLS                  = 0x0F,
         kServiceTypeDVB_MHP                  = 0x10,
         kServiceTypeHDTV                     = 0x19,
+        kServiceTypeEchoStarTV1              = 0x91,
+        kServiceTypeEchoStarTV2              = 0x9a,
+        kServiceTypeEchoStarTV3              = 0xa4,
+        kServiceTypeEchoStarTV4              = 0xa6,
+        kServiceTypeNimiqTV1                 = 0x81,
+        kServiceTypeNimiqTV2                 = 0x85,
+        kServiceTypeNimiqTV3                 = 0x86,
+        kServiceTypeNimiqTV4                 = 0x89,
+        kServiceTypeNimiqTV5                 = 0x8a,
+        kServiceTypeNimiqTV6                 = 0x8d, 
+        kServiceTypeNimiqTV7                 = 0x8f,
+        kServiceTypeNimiqTV8                 = 0x90,
+        kServiceTypeNimiqTV9                 = 0x96,
+
     };
     // service_type             8   2.0
     uint ServiceType(void) const { return _data[2]; }
@@ -1178,7 +1192,20 @@
                                ServiceNameLength());
     }
     bool IsDTV(void) const
-        { return ServiceType() ==  kServiceTypeDigitalTelevision; }
+        { return ((ServiceType() ==  kServiceTypeDigitalTelevision) ||
+                  (ServiceType() ==  kServiceTypeEchoStarTV1) ||
+                  (ServiceType() ==  kServiceTypeEchoStarTV2) ||
+                  (ServiceType() ==  kServiceTypeEchoStarTV3) ||
+                  (ServiceType() ==  kServiceTypeEchoStarTV4) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV1) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV2) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV3) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV4) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV5) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV6) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV7) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV8) ||
+                  (ServiceType() ==  kServiceTypeNimiqTV9)); }
     bool IsDigitalAudio(void) const
         { return ServiceType() ==  kServiceTypeDigitalRadioSound; }
     bool IsHDTV(void) const
diff -Naur mythtv-0.20-old/libs/libmythtv/NuppelVideoPlayer.cpp mythtv-0.20-new/libs/libmythtv/NuppelVideoPlayer.cpp
--- mythtv-0.20-old/libs/libmythtv/NuppelVideoPlayer.cpp	2006-09-04 19:37:19.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/NuppelVideoPlayer.cpp	2006-10-03 14:08:51.000000000 -0700
@@ -573,7 +573,7 @@
 
 void NuppelVideoPlayer::ReinitOSD(void)
 {
-    if (videoOutput)
+    if (videoOutput && !using_null_videoout)
     {
         QRect visible, total;
         float aspect, scaling;
@@ -6314,11 +6314,10 @@
     int numbuttons = ringBuffer->DVD()->NumMenuButtons();
     bool osdshown = osd->IsSetDisplaying("subtitles");
     long long menupktpts = ringBuffer->DVD()->GetMenuPktPts();
-    bool instillframe = ringBuffer->DVD()->InStillFrame();
 
     if ((numbuttons == 0) || 
         (osdshown) ||
-        (instillframe && buffer->timecode > 0) ||
+        (indvdstillframe && buffer->timecode > 0) ||
         ((!osdshown) && 
             (!indvdstillframe) &&
             (hidedvdbutton) &&
diff -Naur mythtv-0.20-old/libs/libmythtv/osdtypes.cpp mythtv-0.20-new/libs/libmythtv/osdtypes.cpp
--- mythtv-0.20-old/libs/libmythtv/osdtypes.cpp	2006-09-04 11:33:22.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/osdtypes.cpp	2006-10-03 14:08:51.000000000 -0700
@@ -2146,7 +2146,7 @@
         QPoint((int)round(pos.x() / wmult),
                (int)round(pos.y() / hmult)));
 
-    VERBOSE(VB_IMPORTANT,
+    VERBOSE(VB_OSD,
             "OSDTypePositionImage::AddPosition["<<m_numpositions<<"]("
             <<pos.x()<<"x"<<pos.y()
             <<"  "<<wmult<<", "<<hmult<<")");
@@ -2157,7 +2157,7 @@
 void OSDTypePositionImage::Draw(OSDSurface *surface, int fade, int maxfade,
                                 int xoff, int yoff)
 {
-    VERBOSE(VB_IMPORTANT,
+    VERBOSE(VB_OSD,
             "OSDTypePositionImage::Draw["<<m_curposition<<"]("
             <<m_wmult<<", "<<m_hmult<<")");
 
diff -Naur mythtv-0.20-old/libs/libmythtv/programinfo.cpp mythtv-0.20-new/libs/libmythtv/programinfo.cpp
--- mythtv-0.20-old/libs/libmythtv/programinfo.cpp	2006-09-10 21:35:19.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/programinfo.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -309,6 +309,7 @@
     INT_TO_LIST(hasAirDate)     
     STR_TO_LIST((playgroup != "") ? playgroup : "Default")
     INT_TO_LIST(recpriority2)
+    INT_TO_LIST(parentid)
 }
 
 /** \fn ProgramInfo::FromStringList(QStringList&,int)
@@ -407,6 +408,7 @@
     INT_FROM_LIST(hasAirDate);
     STR_FROM_LIST(playgroup)
     INT_FROM_LIST(recpriority2)
+    INT_FROM_LIST(parentid)
 
     return true;
 }
@@ -1039,7 +1041,11 @@
     query.prepare("UPDATE recorded "
                   "SET recordid = :RECID "
                   "WHERE chanid = :CHANID AND starttime = :START");
-    query.bindValue(":RECID",  getRecordID());
+
+    if (rectype == kOverrideRecord && parentid > 0)
+        query.bindValue(":RECID", parentid);
+    else
+        query.bindValue(":RECID",  getRecordID());
     query.bindValue(":CHANID", chanid);
     query.bindValue(":START",  recstartts);
 
@@ -1419,15 +1425,15 @@
     return true;
 }               
 
-/** \fn ProgramInfo::GetRecordBasename(void) const
+/** \fn ProgramInfo::GetRecordBasename() const
  *  \brief Returns a filename for a recording based on the
  *         recording channel and date.
  */
-QString ProgramInfo::GetRecordBasename(void) const
+QString ProgramInfo::GetRecordBasename(bool fromDB) const
 {
     QString retval = "";
 
-    if (!pathname.isEmpty())
+    if (!fromDB && !pathname.isEmpty())
         retval = pathname.section('/', -1);
     else
     {
@@ -1452,13 +1458,13 @@
     return retval;
 }               
 
-/** \fn ProgramInfo::GetRecordFilename(const QString&) const
+/** \fn ProgramInfo::GetRecordFilename() const
  *  \brief Returns prefix+"/"+GetRecordBasename()
  *  \param prefix Prefix to apply to GetRecordBasename().
  */
-QString ProgramInfo::GetRecordFilename(const QString &prefix) const
+QString ProgramInfo::GetRecordFilename(const QString &prefix, bool fromDB) const
 {
-    return QString("%1/%2").arg(prefix).arg(GetRecordBasename());
+    return QString("%1/%2").arg(prefix).arg(GetRecordBasename(fromDB));
 }               
 
 /** \fn ProgramInfo::GetPlaybackURL(QString) const
@@ -1566,9 +1572,11 @@
 
     query.prepare("REPLACE INTO recordedprogram"
                  " SELECT * from program"
-                 " WHERE chanid = :CHANID AND starttime = :START;");
+                 " WHERE chanid = :CHANID AND starttime = :START"
+                 " AND title = :TITLE;");
     query.bindValue(":CHANID", chanid);
     query.bindValue(":START", startts);
+    query.bindValue(":TITLE", title);
     if (!query.exec() || !query.isActive())
         MythContext::DBError("Copy program data on record", query);
 
@@ -1662,17 +1670,28 @@
     query.bindValue(":PROFILE",     schd->getProfileName());
 
     bool ok = query.exec() && (query.numRowsAffected() > 0);
-    if (!ok && !query.isActive())
+    bool active = query.isActive();
+
+    query.prepare("UNLOCK TABLES");
+    query.exec();
+
+    if (!ok && !active)
         MythContext::DBError("insert_program -- insert", query);
     else
     {
         query.prepare("UPDATE record SET last_record = NOW() "
                       "WHERE recordid = :RECORDID");
-        query.bindValue(":RECORDID",    pg->recordid);
+        query.bindValue(":RECORDID", pg->recordid);
         query.exec();
+
+        if (pg->rectype == kOverrideRecord && pg->parentid > 0)
+        {
+            query.prepare("UPDATE record SET last_record = NOW() "
+                          "WHERE recordid = :PARENTID");
+            query.bindValue(":PARENTID", pg->parentid);
+            query.exec();
+        }
     }
-    query.prepare("UNLOCK TABLES");
-    query.exec();
 
     return ok;
 }
@@ -1715,7 +1734,12 @@
                   "WHERE chanid = :CHANID AND "
                   "    starttime = :STARTTIME ");
     query.bindValue(":ENDTIME", recendts);
-    query.bindValue(":RECORDID", recordid);
+
+    if (rectype == kOverrideRecord && parentid > 0)
+        query.bindValue(":RECORDID", parentid);
+    else
+        query.bindValue(":RECORDID", recordid);
+
     query.bindValue(":CHANID", chanid);
     query.bindValue(":STARTTIME", recstartts);
 
@@ -2823,6 +2847,8 @@
         return QObject::tr("K", "RecStatusChar rsLowDiskSpace");
     case rsTunerBusy:
         return QObject::tr("B", "RecStatusChar rsTunerBusy");
+    case rsFailed:
+        return QObject::tr("f", "RecStatusChar rsFailed");
     case rsNotListed:
         return QObject::tr("N", "RecStatusChar rsNotListed");
     case rsNeverRecord:
@@ -2879,6 +2905,8 @@
             return QObject::tr("Low Disk Space");
         case rsTunerBusy:
             return QObject::tr("Tuner Busy");
+        case rsFailed:
+            return QObject::tr("Recorder Failed");
         case rsNotListed:
             return QObject::tr("Not Listed");
         case rsNeverRecord:
@@ -2932,6 +2960,9 @@
         case rsTunerBusy:
             message += QObject::tr("the tuner card was already being used.");
             break;
+        case rsFailed:
+            message += QObject::tr("the recording failed.");
+            break;
         default:
             message = QObject::tr("The status of this showing is unknown.");
             break;
diff -Naur mythtv-0.20-old/libs/libmythtv/programinfo.h mythtv-0.20-new/libs/libmythtv/programinfo.h
--- mythtv-0.20-old/libs/libmythtv/programinfo.h	2006-07-14 12:31:24.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/programinfo.h	2006-10-03 14:08:52.000000000 -0700
@@ -13,7 +13,7 @@
 typedef QMap<long long, long long> frm_pos_map_t;
 typedef QMap<long long, int> frm_dir_map_t;
 
-#define NUMPROGRAMLINES 41
+#define NUMPROGRAMLINES 42
 
 typedef enum {
     MARK_UNSET = -10,
@@ -59,6 +59,7 @@
 };
 
 enum RecStatusType {
+    rsFailed = -9,
     rsTunerBusy = -8,
     rsLowDiskSpace = -7,
     rsCancelled = -6,
@@ -157,8 +158,8 @@
 
     // Quick gets
     bool SetRecordBasename(QString basename);
-    QString GetRecordBasename(void) const;
-    QString GetRecordFilename(const QString &prefix) const;
+    QString GetRecordBasename(bool fromDB = false) const;
+    QString GetRecordFilename(const QString &prefix, bool fromDB = false) const;
     QString GetPlaybackURL(QString playbackHost = "") const;
     QString MakeUniqueKey(void) const;
     int CalculateLength(void) const;
diff -Naur mythtv-0.20-old/libs/libmythtv/tv_play.cpp mythtv-0.20-new/libs/libmythtv/tv_play.cpp
--- mythtv-0.20-old/libs/libmythtv/tv_play.cpp	2006-09-07 09:52:11.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/tv_play.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -5445,6 +5445,7 @@
         return;
 
     browsechannum = chan;
+    browsechanid = QString::null;
     BrowseDispInfo(BROWSE_SAME);
 }
 
diff -Naur mythtv-0.20-old/libs/libmythtv/tv_rec.cpp mythtv-0.20-new/libs/libmythtv/tv_rec.cpp
--- mythtv-0.20-old/libs/libmythtv/tv_rec.cpp	2006-09-09 12:45:01.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/tv_rec.cpp	2006-10-03 14:08:52.000000000 -0700
@@ -554,6 +554,10 @@
 
     WaitForEventThreadSleep();
 
+    if ((curRecording) && (curRecording->recstatus == rsFailed) &&
+        (retval == rsRecording))
+        retval = rsFailed;
+
     return retval;
 }
 
@@ -675,20 +679,21 @@
     VERBOSE(VB_RECORD, LOC + QString("FinishedRecording(%1) in recgroup: %2")
                                      .arg(curRec->title).arg(pigrp));
 
-    curRec->recstatus = rsRecorded;
+    if (curRec->recstatus != rsFailed)
+        curRec->recstatus = rsRecorded;
     curRec->recendts = mythCurrentDateTime();
 
     if (tvchain)
         tvchain->FinishedRecording(curRec);
 
+    // Make sure really short recordings have positive run time.
+    if (curRec->recendts <= curRec->recstartts)
+        curRec->recendts = curRec->recstartts.addSecs(60);
+
     curRec->recendts.setTime(QTime(
         curRec->recendts.addSecs(30).time().hour(),
         curRec->recendts.addSecs(30).time().minute()));
 
-    // Make sure really short recordings have positive run time.
-    if (curRec->recendts <= curRec->recstartts)
-        curRec->recendts = mythCurrentDateTime().addSecs(1);
-
     if (pigrp != "LiveTV")
     {
         MythEvent me(QString("UPDATE_RECORDING_STATUS %1 %2 %3 %4 %5")
@@ -699,7 +704,8 @@
                      .arg(curRec->recendts.toString(Qt::ISODate)));
         gContext->dispatch(me);
     }
-    curRec->FinishedRecording(false);
+
+    curRec->FinishedRecording(curRec->recstatus != rsRecorded);
 }
 
 #define TRANSITION(ASTATE,BSTATE) \
@@ -3443,6 +3449,9 @@
     {
         if (!(request.flags & kFlagLiveTV))
         {
+            if (curRecording)
+                curRecording->recstatus = rsFailed;
+
             VERBOSE(VB_IMPORTANT, LOC_ERR +
                     QString("Failed to set channel to %1. "
                             "Reverting to kState_None")
diff -Naur mythtv-0.20-old/libs/libmythtv/videodev2_myth.h mythtv-0.20-new/libs/libmythtv/videodev2_myth.h
--- mythtv-0.20-old/libs/libmythtv/videodev2_myth.h	2006-07-18 08:55:57.000000000 -0700
+++ mythtv-0.20-new/libs/libmythtv/videodev2_myth.h	2006-10-03 14:08:52.000000000 -0700
@@ -721,7 +721,7 @@
 		__s64 value64;
 		void *reserved;
 	};
-};
+}  __attribute__ ((packed));
 
 struct v4l2_ext_controls
 {
diff -Naur mythtv-0.20-old/libs/libmythupnp/httprequest.cpp mythtv-0.20-new/libs/libmythupnp/httprequest.cpp
--- mythtv-0.20-old/libs/libmythupnp/httprequest.cpp	2006-06-07 08:41:00.000000000 -0700
+++ mythtv-0.20-new/libs/libmythupnp/httprequest.cpp	2006-10-03 14:09:05.000000000 -0700
@@ -257,12 +257,16 @@
     else
         m_nResponseStatus = 404;
 
+    QString sDate = QDateTime::currentDateTime().toString( "d MMM yyyy hh:mm:ss" );  
+
     sHeader   = QString("HTTP/%1.%2 %3\r\n"
-                        "Content-Type: %4\r\n"
-                        "Content-Length: %5\r\n" )
+                        "Date: %4\r\n"
+                        "Content-Type: %5\r\n"
+                        "Content-Length: %6\r\n" )
                         .arg( m_nMajor )
                         .arg( m_nMinor )
                         .arg( GetResponseStatus())
+                        .arg( sDate )
                         .arg( sContentType )
                         .arg( llSize       ).utf8();
 
@@ -281,7 +285,19 @@
     {
         __off64_t offset = llStart;
         int       file   = open( sFileName.ascii(), O_RDONLY | O_LARGEFILE );
-        sendfile64( getSocketHandle(), file, &offset, llSize );
+        ssize_t   sent   = 0;  
+
+        do 
+        {  
+            // SSIZE_MAX should work in kernels 2.6.16 and later.  
+            // The loop is needed in any case.  
+
+            sent = sendfile64( getSocketHandle(), file, &offset, 
+                               (size_t)(llSize > INT_MAX ? INT_MAX : llSize));  
+
+            llSize -= sent;  
+        } 
+        while (( sent >= 0 ) && ( llSize > 0 ));  
 
         close( file );
     }
diff -Naur mythtv-0.20-old/programs/mythbackend/mainserver.cpp mythtv-0.20-new/programs/mythbackend/mainserver.cpp
--- mythtv-0.20-old/programs/mythbackend/mainserver.cpp	2006-09-10 21:35:19.000000000 -0700
+++ mythtv-0.20-new/programs/mythbackend/mainserver.cpp	2006-10-03 14:09:07.000000000 -0700
@@ -674,6 +674,36 @@
             return;
         }
 
+        if ((me->Message().left(16) == "DELETE_RECORDING") ||
+            (me->Message().left(22) == "FORCE_DELETE_RECORDING"))
+        {
+            QStringList tokens = QStringList::split(" ", me->Message());
+            if (tokens.size() != 3)
+            {
+                VERBOSE(VB_IMPORTANT, QString("Bad %1 message").arg(tokens[0]));
+                return;
+            }
+
+            QDateTime startts = QDateTime::fromString(tokens[2], Qt::ISODate);
+            ProgramInfo *pinfo = ProgramInfo::GetProgramFromRecorded(tokens[1],
+                                                                     startts);
+            if (pinfo)
+            {
+                if (tokens[0] == "FORCE_DELETE_RECORDING")
+                    DoHandleDeleteRecording(pinfo, NULL, true);
+                else
+                    DoHandleDeleteRecording(pinfo, NULL, false);
+            }
+            else
+            {
+                VERBOSE(VB_IMPORTANT,
+                    QString("Cannot find program info for '%1' while "
+                            "attempting to delete.").arg(me->Message()));
+            }
+
+            return;
+        }
+
         if (me->Message().left(21) == "RESCHEDULE_RECORDINGS" && m_sched)
         {
             QStringList tokens = QStringList::split(" ", me->Message());
@@ -1393,11 +1423,17 @@
     bool followLinks = gContext->GetNumSetting("DeletesFollowLinks", 0);
     bool slowDeletes = gContext->GetNumSetting("TruncateDeletesSlowly", 0);
     int fd = -1;
+    off_t size = 0;
     bool errmsg = false;
 
     /* Delete recording. */
     if (slowDeletes)
     {
+        // Since stat fails after unlinking on some filesystems,
+        // get the filesize first
+        struct stat st;
+        if (stat(ds->filename.ascii(), &st) == 0)
+            size = st.st_size;
         fd = DeleteFile(ds->filename, followLinks);
 
         if ((fd < 0) && checkFile.exists())
@@ -1445,7 +1481,7 @@
     if (slowDeletes && fd != -1)
     {
         m_expirer->TruncatePending();
-        TruncateAndClose(m_expirer, fd, ds->filename);
+        TruncateAndClose(m_expirer, fd, ds->filename, size);
         m_expirer->TruncateFinished();
     }
 }
@@ -1600,7 +1636,8 @@
  *         is running at a time.
  */
 bool MainServer::TruncateAndClose(const AutoExpire *expirer,
-                                  int fd, const QString &filename)
+                                  int fd, const QString &filename,
+                                  off_t fsize)
 {
     QMutexLocker locker(&truncate_and_close_lock);
 
@@ -1621,17 +1658,6 @@
             .arg(increment / (1024.0 * 1024.0), 0, 'f', 2)
             .arg(sleep_time));
 
-    // Get the on disk file size and preferred I/O block size.
-    struct stat buf;
-    fstat(fd, &buf);
-    // Estimate the file size.  Don't use buf.st_blksize * buf.st_blocks
-    // The unit for st_blocks is undefined.  See section "RATIONALE" at
-    // http://www.opengroup.org/onlinepubs/000095399/basedefs/sys/stat.h.html
-    off_t fsize = ((buf.st_size / buf.st_blksize) + 1) * buf.st_blksize;
-
-    // Round truncate increment up to a blocksize, w/min of 1 block.
-    increment = ((increment / buf.st_blksize) + 1) * buf.st_blksize;
-
     while (fsize > 0)
     {
         //VERBOSE(VB_FILE, QString("Truncating '%1' to %2 MB")
@@ -1810,7 +1836,7 @@
         pbssock = pbs->getSocket();
 
     QString fileprefix = gContext->GetFilePrefix();
-    QString filename = pginfo->GetRecordFilename(fileprefix);
+    QString filename = pginfo->GetRecordFilename(fileprefix, true);
 
     // If this recording was made by a another recorder, and that
     // recorder is available, tell it to do the deletion.
diff -Naur mythtv-0.20-old/programs/mythbackend/mainserver.h mythtv-0.20-new/programs/mythbackend/mainserver.h
--- mythtv-0.20-old/programs/mythbackend/mainserver.h	2006-07-03 11:31:35.000000000 -0700
+++ mythtv-0.20-new/programs/mythbackend/mainserver.h	2006-10-03 14:09:07.000000000 -0700
@@ -152,7 +152,8 @@
     static int  DeleteFile(const QString &filename, bool followLinks);
     static int  OpenAndUnlink(const QString &filename);
     static bool TruncateAndClose(const AutoExpire *expirer,
-                                 int fd, const QString &filename);
+                                 int fd, const QString &filename,
+                                 off_t fsize);
 
     QPtrList<LiveTVChain> liveTVChains;
     QMutex liveTVChainsLock;
diff -Naur mythtv-0.20-old/programs/mythbackend/scheduler.cpp mythtv-0.20-new/programs/mythbackend/scheduler.cpp
--- mythtv-0.20-old/programs/mythbackend/scheduler.cpp	2006-09-08 21:20:38.000000000 -0700
+++ mythtv-0.20-new/programs/mythbackend/scheduler.cpp	2006-10-03 14:09:07.000000000 -0700
@@ -1384,6 +1384,14 @@
 
             VERBOSE(VB_GENERAL, msg << ": " << details);
             gContext->LogEntry("scheduler", LP_NOTICE, msg, details);
+
+            if (nextRecording->recstatus == rsFailed)
+            {
+                MythEvent me(QString("FORCE_DELETE_RECORDING %1 %2")
+                         .arg(nextRecording->chanid)
+                         .arg(nextRecording->recstartts.toString(Qt::ISODate)));
+                gContext->dispatch(me);
+            }
         }
 
         if (statuschanged)
diff -Naur mythtv-0.20-old/programs/mythtranscode/mpeg2fix.cpp mythtv-0.20-new/programs/mythtranscode/mpeg2fix.cpp
--- mythtv-0.20-old/programs/mythtranscode/mpeg2fix.cpp	2006-07-18 17:24:00.000000000 -0700
+++ mythtv-0.20-new/programs/mythtranscode/mpeg2fix.cpp	2006-10-03 14:09:07.000000000 -0700
@@ -726,7 +726,8 @@
         {
 
             case CODEC_TYPE_VIDEO:
-                vid_id = i;
+                if(vid_id == -1)
+                    vid_id = i;
                 break;
 
             case CODEC_TYPE_AUDIO:
@@ -1134,6 +1135,12 @@
             if (ret < 0)
             {
                 //insert a bogus frame (this won't be written out)
+                if(vFrame.isEmpty())
+                {
+                    VERBOSE(MPF_IMPORTANT, "Found end of file without finding "
+                                           " any frames");
+                    return TRANSCODE_EXIT_UNKNOWN_ERROR;
+                }
                 MPEG2frame *tmpFrame = GetPoolFrame(&vFrame.last()->pkt);
                 if (tmpFrame == NULL)
                     return TRANSCODE_EXIT_UNKNOWN_ERROR;
diff -Naur mythtv-0.20-old/programs/mythtranscode/replex/element.c mythtv-0.20-new/programs/mythtranscode/replex/element.c
--- mythtv-0.20-old/programs/mythtranscode/replex/element.c	2006-08-28 10:09:05.000000000 -0700
+++ mythtv-0.20-new/programs/mythtranscode/replex/element.c	2006-10-03 14:09:06.000000000 -0700
@@ -480,7 +480,7 @@
 {
 	int c = 0;
 	int fr =0;
-	uint8_t headr[4];
+	uint8_t headr[7];
 
 	af->set=0;
 
@@ -529,7 +529,7 @@
 int get_ac3_info(ringbuffer *rbuf, audio_frame_t *af, int off, int le)
 {
 	int c=0;
-	uint8_t headr[6];
+	uint8_t headr[7];
 	uint8_t frame;
 	int half = 0;
 	int fr;
diff -Naur mythtv-0.20-old/programs/mythtranscode/replex/replex.c mythtv-0.20-new/programs/mythtranscode/replex/replex.c
--- mythtv-0.20-old/programs/mythtranscode/replex/replex.c	2006-08-28 10:09:05.000000000 -0700
+++ mythtv-0.20-new/programs/mythtranscode/replex/replex.c	2006-10-03 14:09:06.000000000 -0700
@@ -294,10 +294,13 @@
 						// add each extra frame required direct to the output file
 						int x;
 						for (x = 0; x < framesdiff; x++){
-							if (type == AC3)
-								write(rx->dmx_out[num+1+rx->apidn], framebuf, aframe->framesize);
-							else
-								write(rx->dmx_out[num+1], framebuf, aframe->framesize);
+							if (type == AC3){
+								if (rx->dmx_out[num+1+rx->apidn])	
+									write(rx->dmx_out[num+1+rx->apidn], framebuf, aframe->framesize);
+							}else{
+								if (rx->dmx_out[num+1])
+									write(rx->dmx_out[num+1], framebuf, aframe->framesize);
+							}
 							*acount += 1;
 						}
 						
diff -Naur mythtv-0.20-old/programs/mythwelcome/welcomedialog.cpp mythtv-0.20-new/programs/mythwelcome/welcomedialog.cpp
--- mythtv-0.20-old/programs/mythwelcome/welcomedialog.cpp	2006-07-25 01:40:11.000000000 -0700
+++ mythtv-0.20-new/programs/mythwelcome/welcomedialog.cpp	2006-10-03 14:09:08.000000000 -0700
@@ -465,7 +465,7 @@
     QStringList strlist;
     
     // get list of current recordings
-    QString querytext = QString("SELECT cardid FROM capturecard;");
+    QString querytext = QString("SELECT cardid FROM capturecard WHERE parentid = 0;");
     MSqlQuery query(MSqlQuery::InitCon());
     query.exec(querytext);
     QString Status = "";
