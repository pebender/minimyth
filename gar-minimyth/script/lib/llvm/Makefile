GARNAME = llvm
GARVERSION = $(LLVM_VERSION)
CATEGORIES = lib
SOURCEPKG = toolchain/llvm
$(GARNAME)_LICENSE_TEXT = $(WORKSRC)/LICENSE.TXT
LICENSE = $(GARNAME)

DESCRIPTION = 
define BLURB
endef

ifneq ($(DESTIMG),build)
DEPENDS = lang/c lang/cxx build-tool/cmake \
	lib/libffi \
	lib/zlib \
	lib/ncursesw
BUILDDEPS = \
	lib/llvm
endif

ifneq ($(DESTIMG),build)
CONFIGURE_SCRIPTS = $(WORKSRC)/cmake
BUILD_SCRIPTS = $(WORKSRC)/cmake
INSTALL_SCRIPTS = $(WORKSRC)/cmake config-$(DESTIMG) links-$(DESTIMG)
endif

CONFIGURE_ARGS = $(LLVM_CONFIGURE_ARGS) \
	-DLLVM_CCACHE_BUILD=ON \
	-DLLVM_TARGETS_TO_BUILD="all" \
	-DLLVM_NATIVE_ARCH="$(GARBUILD)" \
	-DLLVM_HOST_TRIPLE="$(GARHOST)" \
	-DLLVM_DEFAULT_TARGET_TRIPLE="$(GARHOST)" \
	-DLLVM_ENABLE_PROJECTS="" \
	-DLLVM_ENABLE_LIBCXX=ON \
	-DLLVM_USE_LINKER="lld" \
	-DLLVM_ENABLE_LTO="thin" \
	-DLLVM_INSTALL_TOOLCHAIN_ONLY=OFF \
	-DLLVM_INSTALL_BINUTILS_SYMLINKS=OFF \
	-DLLVM_ENABLE_RTTI=ON \
	-DLLVM_ENABLE_PROJECTS="" \
	-DLLVM_BUILD_LLVM_DYLIB=ON \
	-DLIBCXX_CXX_ABI="default" \
	-DLIBCXX_USE_COMPILER_RT=ON \
	-DLIBCXXABI_USE_COMPILER_RT=ON \
	-DLIBCXXABI_USE_LLVM_UNWINDER=ON \
	-DLIBCXXABI_LIBCXX_INCLUDES="$(DESTDIR)$(includedir)/c++/v1" \
	-DLIBCXXABI_LIBUNWIND_INCLUDES="$(DESTDIR)$(includedir)" \
	-DLIBUNWIND_USE_COMPILER_RT=ON \
	-DCOMPILER_RT_USE_LIBCXX=ON \
	-DCOMPILER_RT_USE_LIBC=ON \
	-DCOMPILER_RT_USE_BUILTINS_LIBRARY=ON \
	-DCOMPILER_RT_EXCLUDE_ATOMIC_BUILTIN=OFF \
	-DCOMPILER_RT_HAS_ATOMIC_KEYWORD=ON \
	-DCOMPILER_RT_BUILD_BUILTINS=ON \
	-DCOMPILER_RT_BUILD_CRT=ON \
	-DCOMPILER_RT_BUILD_SANITIZERS=ON \
	-DCOMPILER_RT_BUILD_XRAY=ON \
	-DCOMPILER_RT_BUILD_LIBFUZZER=ON
ifneq ($(DESTIMG),build)
CONFIGURE_ARGS += \
	-DLLVM_TABLEGEN=$(build_DESTDIR)$(build_bindir)/llvm-tblgen
endif

GAR_EXTRA_CONF += devel/cmake/package-api.mk
GAR_EXTRA_CONF += toolchain/llvm/package-api.mk
include ../../gar.mk

CFLAGS += -fPIC
CXXFLAGS += -fPIC
LDFLAGS += -fPIC
