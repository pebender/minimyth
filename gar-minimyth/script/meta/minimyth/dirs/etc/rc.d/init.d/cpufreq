#!/bin/sh
################################################################################
# cpufreq
################################################################################
. /etc/rc.d/functions

start() {
    mm_message_output info 'starting CPU frequency scaling ...'

    if [ ! "${MM_CPUFREQ_GOVERNOR}" = "performance" ] ; then
        case "${MM_HARDWARE_CPU}" in
            ATHLON64)
                modprobe powernow-k8
                ;;
            C3|C3-2)
                modprobe longhaul
                ;;
        esac

        case "${MM_CPUFREQ_GOVERNOR}" in
            performance)
                ;;
            powersave)
                modprobe cpufreq-powersave
                ;;
            ondemand)
                modprobe cpufreq-ondemand
                ;;
            conservative)
                modprobe cpufreq-conservative
                ;;
            userspace)
                modprobe cpufreq-userspace
                powernowd
                ;;
        esac
        modprobe cpufreq-stats


        for dir in /sys/devices/system/cpu/cpu*/cpufreq ; do
            echo "${MM_CPUFREQ_GOVERNOR}" > ${dir}/scaling_governor
        done
    fi
}

stop() {
    mm_message_output info 'stopping CPU frequency scaling ...'

    if [ -n "`pidof powernowd`" ] ; then
        killall powernowd
    fi

    for dir in /sys/devices/system/cpu/cpu*/cpufreq ; do
        echo performance > ${dir}/scaling_governor
    done

    return 0
}

case $1 in
    start) start ;;
    stop)  stop  ;;
esac

exit 0
