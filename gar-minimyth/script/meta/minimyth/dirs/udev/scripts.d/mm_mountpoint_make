#!/bin/sh

name="$1"
action="$2"

label_get()
{
    name="$1"

    label=""
    case ${name} in
        hd[a-z]*)
            label=`/lib/udev/vol_id -l /dev/${name} 2> /dev/null` || /bin/true
            ;;
        sd[a-z]*)
            label=`/lib/udev/vol_id -l /dev/${name} 2> /dev/null` || /bin/true
            ;;
    esac

    /bin/echo ${label}
}

minimyth_add()
{
    name="$1"

    /bin/mkdir -p /minimyth
    /bin/mount -t auto /dev/${name} /minimyth || /bin/true
}

minimyth_remove()
{
    name="$1"

    /bin/umount -l /minimyth || /bin/true
    /bin/rmdir /minimyth
}

mountpoint_add()
{
    name="$1"
    symlink="$2"

    /bin/mkdir -p /media/${symlink}
    case ${name} in
        hd[a-z])
            ;;
        sd[a-z])
            /bin/mount -t auto /dev/${symlink} /media/${symlink} || /bin/true
            ;;
        sr[0-9]*)
            ;;
    esac
}

mountpoint_remove()
{
    name="$1"
    symlink="$2"

    /bin/umount -l /media/${symlink} || /bin/true
    /bin/rmdir /media/${symlink}
}

case ${action} in
    add)
        label=`${label_get} "${name}"`
        if /usr/bin/test "${label}" = "minimyth" ; then
            minimyth_add "${name}"
        else
            symlinks="${DEVLINKS}"
            for symlink in ${symlinks} ; do
                symlink=`/bin/echo ${symlink} | /bin/sed 's%//*%/%g' | /bin/sed 's%^/dev/%%'`
                mountpoint_remove "${name}" "${symlink}"
                mountpoint_add    "${name}" "${symlink}"
            done
        fi
        ;;
    remove)
        label=`${label_get} "${name}"`
        if /usr/bin/test "${label}" = "minimyth" ; then
            minimyth_remove "${name}"
        else
            symlinks="${DEVLINKS}"
            for symlink in ${symlinks} ; do
                symlink=`/bin/echo ${symlink} | /bin/sed 's%//*%/%g' | /bin/sed 's%^/dev/%%'`
                mountpoint_remove "${name}" "${symlink}"
            done
        fi
        ;;
esac
