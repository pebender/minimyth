#!/bin/sh

DEVICE="$1"
ACTION="$2"

map_remove()
{
    NAME="$1"

    mkdir -p /mnt/dev
    rm -f /mnt/dev/.map~
    touch /mnt/dev/.map
    cat /mnt/dev/.map |
    while read dev ; do
        dev_name=`echo ${dev}    | cut -d= -f1`
        dev_symlink=`echo ${dev} | cut -d= -f2`
        if [ ! "${dev_name}" = "${NAME}" ] ; then
            echo "${dev_name}=${dev_symlink}" >> /mnt/dev/.map~
        fi
    done
    mv -f /mnt/dev/.map~ /mnt/dev/.map
}

map_add()
{
    NAME="$1"
    SYMLINKS="$2"

    map_remove "${NAME}"

    for symlink in ${SYMLINKS} ; do
        dev_name="${NAME}"
        dev_symlink="${symlink}"
        echo "${dev_name}=${dev_symlink}" >> /mnt/dev/.map
    done
}

case ${DEVICE} in
    hd[a-z])
        MOUNT=true
        UMOUNT=true
        ;;
    sd[a-z])
        MOUNT=mount
        UMOUNT=umount
        ;;
    sr[0-9]*)
        MOUNT=true
        UMOUNT=true
        ;;
esac

case ${ACTION} in
    add)
        dev_list=`ls -l /dev | grep "${DEVICE}$" | sed 's% *-> *[^ ]*%%' | sed 's%.* %/dev/%'`
        map_add "${DEVICE}" "${dev_list}"
        dev_list=`cat /mnt/dev/.map | grep "^${DEVICE}=" | sed "s%^${DEVICE}=%%"`
        for dev in ${dev_list} ; do
            mkdir -p /mnt/${dev}
            ${MOUNT} -t auto ${dev} /mnt/${dev}
        done
        ;;
    remove)
        dev_list=`cat /mnt/dev/.map | grep "^${DEVICE}=" | sed "s%^${DEVICE}=%%"`
        for dev in ${dev_list} ; do
            ${UMOUNT} -l /mnt/${dev}
            rmdir /mnt/${dev}
        done
        map_remove "${DEVICE}"
        ;;
esac
