#!/bin/sh

# Only allow one running instance of mm_sleep.
pids=`/bin/pidof mm_sleep`
instances=`/bin/echo ${pids} | /usr/bin/wc -w`
if /usr/bin/test ${instances} -ne 1 ; then
    exit 1
fi

. /etc/rc.d/functions

# Create the state directory for mm_sleep.
/bin/rm -fr   /var/lib/mm_sleep.$$
/bin/mkdir -p /var/lib/mm_sleep.$$

# Turn off any external equipment.
/usr/bin/mm_external power_off

# Stop all X applications, except mythfrontend and applications started by xinit.
mm_x_applications_exit ':everything'
mm_x_applications_kill ':everything'
mm_x_applications_dead ':everything'

# Return mythfrontend to its main menu.
mm_x_applications_exit 'mythfrontend'

# Stop LCDd because it can stop working as a result of suspend.
while /usr/bin/test -n "`/bin/pidof LCDd`" ; do
    /bin/touch /var/lib/mm_sleep.$$/LCDd
    /usr/bin/killall LCDd 2> /dev/null
done

# Stop irexec so that the remote button press used to wake up the frontend
# does not suspend the frontend.
while /usr/bin/test -n "`/bin/pidof irexec`" ; do
    /bin/touch /var/lib/mm_sleep.$$/irexec
    /usr/bin/killall irexec 2> /dev/null
done

# Stop mm_sleep_on_ss so that it does not immediately send the frontend back to sleep.
while /usr/bin/test -n "`/bin/pidof mm_sleep_on_ss`" ; do
    /bin/touch /var/lib/mm_sleep.$$/mm_sleep_on_ss
    /usr/bin/killall mm_sleep_on_ss 2> /dev/null
done

# Stop X
if /usr/bin/test "x${MM_X_RESTART_ON_SLEEP_ENABLED}" = "xyes" ; then
    mm_x_stop
fi

/bin/echo mem > /sys/power/state

# Start X
if /usr/bin/test "x${MM_X_RESTART_ON_SLEEP_ENABLED}" = "xyes" ; then
    mm_x_start
fi

# If mm_sleep_on_ss was running before suspend, then restart it.
if /usr/bin/test -e /var/lib/mm_sleep.$$/mm_sleep_on_ss ; then
    /usr/bin/test -z `/bin/pidof mm_sleep_on_ss` && /usr/bin/mm_sleep_on_ss &
    /bin/rm -f /var/lib/mm_sleep.$$/mm_sleep_on_ss
fi

# If irexec was running before suspend, then restart it.
if /usr/bin/test -e /var/lib/mm_sleep.$$/irexec ; then
    /usr/bin/test -z `/bin/pidof irexec` && /usr/bin/irexec -d /etc/lircrc
    /bin/rm -f /var/lib/mm_sleep.$$/irexec
fi

# If LCDd was running before suspend, then restart it.
if /usr/bin/test -e /var/lib/mm_sleep.$$/LCDd ; then
    /usr/bin/test -z `/bin/pidof LDCd` && /usr/sbin/LCDd -c /etc/LCDd.conf
    /bin/rm -f /var/lib/mm_sleep.$$/LCDd
fi

# Turn on any external equipment.
/usr/bin/mm_external power_on

# Remove the state directory for mm_sleep.
/bin/rm -fr   /var/lib/mm_sleep.$$
