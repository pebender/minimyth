#!/bin/sh
################################################################################
# wiimote
################################################################################
. /etc/rc.d.sh/functions

start() {

    local config
    local device
    local device_configured
    local devices
    
    if /usr/bin/test ! -z "${MM_WIIMOTE_ADDRESS_0}" ||
       /usr/bin/test ! -z "${MM_WIIMOTE_ADDRESS_1}" ||
       /usr/bin/test ! -z "${MM_WIIMOTE_ADDRESS_2}" ||
       /usr/bin/test ! -z "${MM_WIIMOTE_ADDRESS_3}" ; then

        mm_message_output info 'starting bluetooth ...'

        devices=`ls -1 /sys/class/bluetooth 2> /dev/null`
        if /usr/bin/test -z "${devices}" ; then
            mm_message_output err "error: no bluetooth device found."
            exit 1
        fi

        device_configured=0
        for device in ${devices} ; do
            if /usr/sbin/hciconfig ${device} up > /dev/null 2>&1 ; then
                device_configured=1
            else
                mm_message_output warn "warning: configuration of bluetooth device '${device}' failed."
            fi
        done
        if /usr/bin/test "${device_configured}" -eq 0 ; then
            mm_message_output err "error: no bluetooth device configured."
            exit 1
        fi

        mm_message_output info 'starting wminput ...'

        # Start
        if /usr/bin/test ! -e '/dev/uinput' ; then
            if ! /sbin/modprobe uinput > /dev/null 2>&1 ; then
                mm_message_output err "error: failed to load kernel module: uinput"
                exit 1
            fi
            while /usr/bin/test ! -e '/dev/uinput' ; do
                sleep 1
            done
        fi

        if /usr/bin/test -n "${MM_WIIMOTE_ADDRESS_0}" ; then
            config=''
            if /usr/bin/test -e '/etc/cwiid/wminput/default_0' ; then
                config='/etc/cwiid/wminput/default_0'
            else
                mm_message_output err "error: no 'wminput' config file found."
                exit 1
            fi
            if /usr/bin/hcitool con 2> /dev/null | /bin/grep -q -e "[[:cntrl:]]*< ACL ${MM_WIIMOTE_ADDRESS_0}" ; then
               mm_message_output info "Wiimote 0 (address: ${MM_WIIMOTE_ADDRESS_0}) not started because it is already running"
            else
               /usr/bin/wminput -d -c ${config} ${MM_WIIMOTE_ADDRESS_0} > /dev/null 2>&1 &
            fi
        fi
        if /usr/bin/test -n "${MM_WIIMOTE_ADDRESS_1}" ; then
            config=''
            if /usr/bin/test -e '/etc/cwiid/wminput/default_1' ; then
                config='/etc/cwiid/wminput/default_1'
            else
                mm_message_output err "error: no 'wminput' config file found."
                exit 1
            fi
            if /usr/bin/hcitool con 2> /dev/null | /bin/grep -q -e "[[:cntrl:]]*< ACL ${MM_WIIMOTE_ADDRESS_1}" ; then
               mm_message_output info "Wiimote 1 (address: ${MM_WIIMOTE_ADDRESS_1}) not started because it is already running"
            else
               /usr/bin/wminput -d -c ${config} ${MM_WIIMOTE_ADDRESS_1} > /dev/null 2>&1 &
            fi
        fi
        if /usr/bin/test -n "${MM_WIIMOTE_ADDRESS_2}" ; then
            config=''
            if /usr/bin/test -e '/etc/cwiid/wminput/default_2' ; then
                config='/etc/cwiid/wminput/default_2'
            else
                mm_message_output err "error: no 'wminput' config file found."
                exit 1
            fi
            if /usr/bin/hcitool con 2> /dev/null | /bin/grep -q -e "[[:cntrl:]]*< ACL ${MM_WIIMOTE_ADDRESS_2}" ; then
               mm_message_output info "Wiimote 2 (address: ${MM_WIIMOTE_ADDRESS_2}) not started because it is already running"
            else
               /usr/bin/wminput -d -c ${config} ${MM_WIIMOTE_ADDRESS_2} > /dev/null 2>&1 &
            fi
        fi
        if /usr/bin/test -n "${MM_WIIMOTE_ADDRESS_3}" ; then
            config=''
            if /usr/bin/test -e '/etc/cwiid/wminput/default_3' ; then
                config='/etc/cwiid/wminput/default_3'
            else
                mm_message_output err "error: no 'wminput' config file found."
                exit 1
            fi
            if /usr/bin/hcitool con 2> /dev/null | /bin/grep -q -e "[[:cntrl:]]*< ACL ${MM_WIIMOTE_ADDRESS_3}" ; then
               mm_message_output info "Wiimote 3 (address: ${MM_WIIMOTE_ADDRESS_3}) not started because it is already running"
            else
               /usr/bin/wminput -d -c ${config} ${MM_WIIMOTE_ADDRESS_3} > /dev/null 2>&1 &
            fi
        fi
    fi

    return 0
}


stop() {

    if /usr/bin/test -n "`/bin/pidof wminput`" ; then
        mm_message_output info 'stopping wminput ...'

        /usr/bin/killall wminput
    fi

    return 0
}

case $1 in
    start) start ;;
    stop)  stop  ;;
esac

exit 0
